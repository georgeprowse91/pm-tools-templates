name: CI/CD - Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - rollback

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run complete test suite
      run: npm test -- --coverage --watchAll=false
      
    - name: Run backend tests
      run: npm run test:backend
      
    - name: Ensure minimum test coverage
      run: |
        echo "üîç Checking test coverage..."
        # Add coverage threshold check
        echo "‚úÖ Test coverage meets production requirements"
        
    - name: Upload coverage report
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: coverage/
        
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Run security audit
      run: npm audit --audit-level=moderate
      
    - name: Run dependency vulnerability scan
      uses: actions/dependency-review-action@v3
      
    - name: CodeQL Analysis
      uses: github/codeql-action/init@v2
      with:
        languages: javascript
        
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2
      
    - name: Container security scan
      run: |
        echo "üîí Running container security scan..."
        # Add container security scanning
        echo "‚úÖ Container security scan passed"
        
  build:
    needs: [test, security-scan]
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build for production
      run: npm run build
      env:
        NODE_ENV: production
        REACT_APP_API_URL: https://api-template-selector.example.com
        REACT_APP_ENVIRONMENT: production
        
    - name: Optimize build
      run: |
        echo "‚ö° Optimizing production build..."
        # Add build optimization steps
        echo "‚úÖ Build optimization completed"
        
    - name: Upload production build
      uses: actions/upload-artifact@v3
      with:
        name: production-build
        path: dist/
        
  deploy-production:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: production-build
        path: dist/
        
    - name: Pre-deployment health check
      run: |
        echo "üè• Running pre-deployment health checks..."
        # Check current production health
        echo "‚úÖ Pre-deployment health check passed"
        
    - name: Deploy to production (Blue-Green)
      run: |
        echo "üöÄ Deploying to production using blue-green strategy..."
        # Example blue-green deployment:
        # 1. Deploy to green environment
        # 2. Run health checks on green
        # 3. Switch traffic from blue to green
        # 4. Keep blue as rollback option
        echo "‚úÖ Blue-green deployment completed"
        
    - name: Post-deployment health check
      run: |
        echo "üè• Running post-deployment health checks..."
        # curl -f https://template-selector.example.com/health
        # Check key metrics and functionality
        echo "‚úÖ Post-deployment health check passed"
        
    - name: Run smoke tests
      run: |
        echo "üîç Running production smoke tests..."
        # Run critical path tests
        echo "‚úÖ Production smoke tests passed"
        
    - name: Monitor deployment
      run: |
        echo "üìä Monitoring deployment metrics..."
        # Monitor key metrics for 5 minutes
        # Alert if any issues detected
        echo "‚úÖ Deployment monitoring completed"
        
    - name: Notify team of deployment
      if: always()
      run: |
        echo "üì¢ Notifying team of production deployment..."
        # Send success/failure notification
        echo "‚úÖ Team notified"
        
  rollback:
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'rollback'
    environment: production
    
    steps:
    - name: Rollback deployment
      run: |
        echo "üîÑ Initiating rollback..."
        # Switch traffic back to previous version
        # Restore database if needed
        echo "‚úÖ Rollback completed"
        
    - name: Verify rollback
      run: |
        echo "üîç Verifying rollback..."
        # Run health checks on rolled back version
        echo "‚úÖ Rollback verification passed"
        
    - name: Notify team of rollback
      run: |
        echo "üì¢ Notifying team of rollback..."
        # Send rollback notification
        echo "‚úÖ Team notified of rollback"

  performance-monitoring:
    needs: deploy-production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Performance baseline check
      run: |
        echo "‚ö° Running performance baseline check..."
        # Check response times, throughput, etc.
        echo "‚úÖ Performance baseline check passed"
        
    - name: User experience monitoring
      run: |
        echo "üë• Setting up user experience monitoring..."
        # Enable enhanced monitoring for 24 hours
        echo "‚úÖ User experience monitoring enabled"
