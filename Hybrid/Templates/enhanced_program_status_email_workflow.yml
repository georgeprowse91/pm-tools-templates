name: üìä Enhanced Program Status Email Workflow

# This workflow addresses Issue #314: Make Clean Status Workflow a production-ready template
# for generating program-level weekly status emails with executive-friendly formatting
# GitHub Issue: https://github.com/mirichard/pm-tools-templates/issues/314

on:
  schedule:
    # Generate weekly status reports every Friday at 4 PM UTC
    - cron: '0 16 * * 5'
    # Send Monday morning status emails at 7 AM UTC  
    - cron: '0 7 * * 1'
  # Allow manual triggering for testing and customization
  workflow_dispatch:
    inputs:
      program_name:
        description: 'Program name for the status report'
        required: true
        default: 'Digital Transformation Program'
        type: string
      test_mode:
        description: 'Run in test mode (no email sent)'
        required: false
        default: 'false'
        type: boolean
      report_type:
        description: 'Type of status report'
        required: true
        default: 'weekly'
        type: choice
        options:
          - weekly
          - monthly
          - sprint
          - milestone
      methodology:
        description: 'Program methodology'
        required: false
        default: 'hybrid'
        type: choice
        options:
          - agile
          - traditional
          - hybrid
      executive_summary_only:
        description: 'Generate executive summary only (1-3 min read)'
        required: false
        default: 'true'
        type: boolean

env:
  # Configure these in your repository secrets for production use
  MAIL_RECIPIENTS: ${{ secrets.PROGRAM_STAKEHOLDERS_EMAIL || 'program-stakeholders@company.com' }}
  MAIL_FROM: ${{ secrets.PROGRAM_EMAIL_FROM || 'program-manager@company.com' }}
  PROGRAM_DASHBOARD_URL: ${{ secrets.PROGRAM_DASHBOARD_URL || 'https://company.sharepoint.com/program-dashboard' }}
  DETAILED_REPORTS_URL: ${{ secrets.DETAILED_REPORTS_URL || 'https://company.sharepoint.com/program-reports' }}

jobs:
  collect-program-metrics:
    name: üìä Collect Program-Level Metrics
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: read
      pull-requests: read
      actions: read
    outputs:
      # Program-level metrics
      program_health: ${{ steps.program_metrics.outputs.program_health }}
      total_projects: ${{ steps.program_metrics.outputs.total_projects }}
      projects_on_track: ${{ steps.program_metrics.outputs.projects_on_track }}
      projects_at_risk: ${{ steps.program_metrics.outputs.projects_at_risk }}
      projects_critical: ${{ steps.program_metrics.outputs.projects_critical }}
      
      # Overall completion metrics
      overall_completion: ${{ steps.program_metrics.outputs.overall_completion }}
      budget_performance: ${{ steps.program_metrics.outputs.budget_performance }}
      schedule_performance: ${{ steps.program_metrics.outputs.schedule_performance }}
      
      # Risk and issue metrics
      critical_actions: ${{ steps.program_metrics.outputs.critical_actions }}
      escalated_issues: ${{ steps.program_metrics.outputs.escalated_issues }}
      program_risks: ${{ steps.program_metrics.outputs.program_risks }}
      
      # Project status data
      project_status_json: ${{ steps.project_analysis.outputs.project_status_json }}

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üìä Analyze Program-Level Metrics
        id: program_metrics
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PROGRAM_NAME: ${{ github.event.inputs.program_name || 'Digital Transformation Program' }}
        run: |
          echo "üîç Analyzing program-level metrics for: $PROGRAM_NAME"
          
          # Collect project-level issues with enhanced labeling
          TOTAL_ISSUES=$(gh issue list --state all --json number | jq length)
          OPEN_ISSUES=$(gh issue list --state open --json number | jq length)
          CLOSED_ISSUES=$(gh issue list --state closed --json number | jq length)
          
          # Program-specific metrics
          CRITICAL_ACTIONS=$(gh issue list --label "critical-action" --state open --json number | jq length)
          PROGRAM_RISKS=$(gh issue list --label "program-risk" --state open --json number | jq length)
          ESCALATED_ISSUES=$(gh issue list --label "escalation" --state open --json number | jq length)
          
          # Project health analysis (based on milestone and label analysis)
          PROJECT_A_ISSUES=$(gh issue list --label "project-a" --state open --json number | jq length)
          PROJECT_B_ISSUES=$(gh issue list --label "project-b" --state open --json number | jq length)
          PROJECT_C_ISSUES=$(gh issue list --label "project-c" --state open --json number | jq length)
          
          # Calculate program health metrics
          if [ $TOTAL_ISSUES -gt 0 ]; then
            OVERALL_COMPLETION=$(( CLOSED_ISSUES * 100 / TOTAL_ISSUES ))
          else
            OVERALL_COMPLETION=0
          fi
          
          # Simulate project count (in real implementation, this would come from project management system)
          TOTAL_PROJECTS=4
          PROJECTS_ON_TRACK=2
          PROJECTS_AT_RISK=1
          PROJECTS_CRITICAL=1
          
          # Calculate program health status
          if [ $PROJECTS_CRITICAL -gt 0 ]; then
            PROGRAM_HEALTH="RED"
          elif [ $PROJECTS_AT_RISK -gt 0 ]; then
            PROGRAM_HEALTH="AMBER"
          else
            PROGRAM_HEALTH="GREEN"
          fi
          
          # Simulate budget and schedule performance (integrate with your PM tools)
          BUDGET_PERFORMANCE="ON_TRACK"  # ON_TRACK, OVER_BUDGET, UNDER_BUDGET
          SCHEDULE_PERFORMANCE="AT_RISK"  # ON_TRACK, AT_RISK, BEHIND
          
          # Store outputs
          echo "program_health=$PROGRAM_HEALTH" >> $GITHUB_OUTPUT
          echo "total_projects=$TOTAL_PROJECTS" >> $GITHUB_OUTPUT
          echo "projects_on_track=$PROJECTS_ON_TRACK" >> $GITHUB_OUTPUT
          echo "projects_at_risk=$PROJECTS_AT_RISK" >> $GITHUB_OUTPUT
          echo "projects_critical=$PROJECTS_CRITICAL" >> $GITHUB_OUTPUT
          echo "overall_completion=$OVERALL_COMPLETION" >> $GITHUB_OUTPUT
          echo "budget_performance=$BUDGET_PERFORMANCE" >> $GITHUB_OUTPUT
          echo "schedule_performance=$SCHEDULE_PERFORMANCE" >> $GITHUB_OUTPUT
          echo "critical_actions=$CRITICAL_ACTIONS" >> $GITHUB_OUTPUT
          echo "escalated_issues=$ESCALATED_ISSUES" >> $GITHUB_OUTPUT
          echo "program_risks=$PROGRAM_RISKS" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Program metrics collected successfully"

      - name: üéØ Analyze Individual Project Status
        id: project_analysis
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Analyzing individual project statuses..."
          
          # Create project status JSON with real GitHub data
          # In production, this would integrate with your project management tools
          cat > project_status.json << 'EOF'
          [
            {
              "name": "Core Infrastructure",
              "rag_status": "üü¢ Green",
              "schedule_trend": "‚ñ∫ On Track",
              "budget_trend": "‚ñ∫ On Track", 
              "key_notes": "Cloud migration 85% complete, no blocking issues",
              "critical_issues": [],
              "owner": "Infrastructure Team",
              "completion": 85
            },
            {
              "name": "Customer Portal",
              "rag_status": "üü° Amber",
              "schedule_trend": "‚ñº Behind",
              "budget_trend": "‚ñ∫ On Track",
              "key_notes": "Integration testing delayed 5 days; QA overload",
              "critical_issues": ["Integration testing bottleneck", "QA resource shortage"],
              "owner": "Development Team",
              "completion": 65
            },
            {
              "name": "Analytics Platform", 
              "rag_status": "üü¢ Green",
              "schedule_trend": "‚ñ≤ Ahead",
              "budget_trend": "‚ñ≤ Under Budget",
              "key_notes": "Dashboard development ahead of schedule",
              "critical_issues": [],
              "owner": "Analytics Team",
              "completion": 90
            },
            {
              "name": "Mobile Application",
              "rag_status": "üî¥ Red", 
              "schedule_trend": "‚ñº Behind",
              "budget_trend": "‚ñº Over Budget",
              "key_notes": "UI redesign required; budget overrun $25K",
              "critical_issues": ["UI/UX redesign scope creep", "Budget approval needed"],
              "owner": "Mobile Team",
              "completion": 45
            }
          ]
          EOF
          
          # Store the JSON as output for email generation
          PROJECT_STATUS_JSON=$(cat project_status.json | jq -c .)
          echo "project_status_json=$PROJECT_STATUS_JSON" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Project analysis completed"

  generate-executive-email:
    name: üìß Generate Executive Status Email
    needs: collect-program-metrics
    runs-on: ubuntu-latest
    outputs:
      email_content: ${{ steps.email_generation.outputs.email_file }}
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üìß Generate Executive-Friendly Status Email
        id: email_generation
        env:
          PROGRAM_NAME: ${{ github.event.inputs.program_name || 'Digital Transformation Program' }}
          PROGRAM_HEALTH: ${{ needs.collect-program-metrics.outputs.program_health }}
          OVERALL_COMPLETION: ${{ needs.collect-program-metrics.outputs.overall_completion }}
          CRITICAL_ACTIONS: ${{ needs.collect-program-metrics.outputs.critical_actions }}
          PROJECT_STATUS_JSON: ${{ needs.collect-program-metrics.outputs.project_status_json }}
          REPORT_TYPE: ${{ github.event.inputs.report_type || 'weekly' }}
        run: |
          echo "üìß Generating executive-friendly status email..."
          
          # Create email directory
          mkdir -p email/
          
          # Extract critical projects that need attention
          CRITICAL_PROJECTS=$(echo '${{ env.PROJECT_STATUS_JSON }}' | jq -r '.[] | select(.rag_status | contains("üî¥") or contains("üü°")) | .name' | head -3)
          
          # Generate mobile-friendly HTML email
          cat > email/program-status-email.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Program ${PROGRAM_NAME} - Weekly Status $(date +"%B %d, %Y")</title>
            <style>
              /* Mobile-first responsive design */
              body { 
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                line-height: 1.6; 
                color: #333; 
                max-width: 600px; 
                margin: 0 auto; 
                padding: 20px;
                background-color: #f8f9fa;
              }
              .container {
                background: white;
                border-radius: 8px;
                overflow: hidden;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
              }
              .header { 
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 30px 20px;
                text-align: center;
              }
              .header h1 { 
                margin: 0; 
                font-size: 24px; 
                font-weight: 600;
              }
              .header p { 
                margin: 8px 0 0 0; 
                opacity: 0.9; 
                font-size: 16px;
              }
              .executive-summary {
                padding: 25px 20px;
                background: #f8f9fa;
                border-bottom: 1px solid #e9ecef;
              }
              .executive-summary h2 {
                margin: 0 0 15px 0;
                color: #495057;
                font-size: 18px;
              }
              .summary-text {
                font-size: 16px;
                line-height: 1.7;
                color: #495057;
              }
              .program-health {
                display: inline-block;
                padding: 4px 12px;
                border-radius: 20px;
                font-weight: 600;
                font-size: 14px;
              }
              .health-green { background: #d4edda; color: #155724; }
              .health-amber { background: #fff3cd; color: #856404; }
              .health-red { background: #f8d7da; color: #721c24; }
              
              .project-status-table {
                margin: 0;
                width: 100%;
                border-collapse: collapse;
                font-size: 14px;
              }
              .project-status-table th {
                background: #e9ecef;
                padding: 12px 8px;
                text-align: left;
                font-weight: 600;
                color: #495057;
                border-bottom: 2px solid #dee2e6;
              }
              .project-status-table td {
                padding: 12px 8px;
                border-bottom: 1px solid #e9ecef;
                vertical-align: top;
              }
              .project-status-table tr:hover {
                background: #f8f9fa;
              }
              .status-indicator {
                font-weight: 600;
                white-space: nowrap;
              }
              .trend-icon {
                font-size: 16px;
                margin-right: 4px;
              }
              
              .critical-actions {
                padding: 20px;
                background: #fff5f5;
                border-left: 4px solid #dc3545;
                margin: 20px 0;
              }
              .critical-actions h3 {
                margin: 0 0 15px 0;
                color: #721c24;
                font-size: 16px;
              }
              .action-item {
                padding: 8px 0;
                border-bottom: 1px solid #f5c6cb;
              }
              .action-item:last-child {
                border-bottom: none;
              }
              .action-owner {
                font-weight: 600;
                color: #495057;
              }
              .action-due {
                color: #dc3545;
                font-weight: 600;
              }
              
              .links-section {
                padding: 20px;
                background: #e7f3ff;
                border-left: 4px solid #007bff;
              }
              .links-section h3 {
                margin: 0 0 15px 0;
                color: #004085;
                font-size: 16px;
              }
              .link-item {
                margin: 8px 0;
              }
              .link-item a {
                color: #007bff;
                text-decoration: none;
                font-weight: 500;
              }
              .link-item a:hover {
                text-decoration: underline;
              }
              
              .metrics-definitions {
                padding: 20px;
                background: #f8f9fa;
                font-size: 12px;
                color: #6c757d;
              }
              .metrics-definitions h4 {
                margin: 0 0 10px 0;
                color: #495057;
                font-size: 14px;
              }
              .definition-item {
                margin: 4px 0;
              }
              
              .footer { 
                padding: 20px;
                text-align: center;
                background: #343a40;
                color: #adb5bd;
                font-size: 12px;
              }
              .footer a {
                color: #17a2b8;
                text-decoration: none;
              }
              
              /* Mobile responsiveness */
              @media (max-width: 600px) {
                body { padding: 10px; }
                .header { padding: 20px 15px; }
                .header h1 { font-size: 20px; }
                .project-status-table { font-size: 12px; }
                .project-status-table th,
                .project-status-table td { padding: 8px 6px; }
                .executive-summary,
                .critical-actions,
                .links-section { padding: 15px; }
              }
            </style>
          </head>
          <body>
            <div class="container">
              <div class="header">
                <h1>üìä Program ${PROGRAM_NAME}</h1>
                <p>Weekly Status Report - $(date +"%B %d, %Y")</p>
              </div>
              
              <!-- Executive Summary (1-3 minute read) -->
              <div class="executive-summary">
                <h2>üéØ Executive Summary</h2>
                <div class="summary-text">
                  Program ${PROGRAM_NAME} is 
                  <span class="program-health health-$(echo $PROGRAM_HEALTH | tr '[:upper:]' '[:lower:]' | sed 's/amber/amber/' | sed 's/red/red/' | sed 's/green/green/')">
                    $(echo $PROGRAM_HEALTH | sed 's/RED/üî¥ At Risk/' | sed 's/AMBER/üü° At Risk/' | sed 's/GREEN/üü¢ On Track/')
                  </span>
                  with ${OVERALL_COMPLETION}% overall completion. 
                  $(echo '${{ env.PROJECT_STATUS_JSON }}' | jq -r '.[] | select(.rag_status | contains("üî¥")) | .name' | wc -l | sed 's/^[ \t]*//' ) projects require immediate attention.
                  Executive decision needed on $(echo $CRITICAL_ACTIONS) critical action items.
                </div>
              </div>
              
              <!-- Project Status Summary Table -->
              <div style="padding: 20px;">
                <h3 style="margin: 0 0 15px 0; color: #495057;">üìã Project Status Overview</h3>
                <div style="overflow-x: auto;">
                  <table class="project-status-table">
                    <thead>
                      <tr>
                        <th>Project Name</th>
                        <th>Status</th>
                        <th>Schedule</th>
                        <th>Budget</th>
                        <th>Key Notes</th>
                      </tr>
                    </thead>
                    <tbody>
          EOF
          
          # Add project rows from JSON data
          echo '${{ env.PROJECT_STATUS_JSON }}' | jq -r '.[] | 
            "<tr>
              <td><strong>\(.name)</strong></td>
              <td class=\"status-indicator\">\(.rag_status)</td>
              <td class=\"status-indicator\">\(.schedule_trend)</td>
              <td class=\"status-indicator\">\(.budget_trend)</td>
              <td>\(.key_notes)</td>
            </tr>"' >> email/program-status-email.html
          
          # Continue with rest of email template
          cat >> email/program-status-email.html << EOF
                    </tbody>
                  </table>
                </div>
              </div>
              
              <!-- Critical Actions & Escalations -->
              <div class="critical-actions">
                <h3>üö® Critical Actions Required</h3>
                <div class="action-item">
                  <div>‚Ä¢ Approve QA contractor hires for Customer Portal project</div>
                  <div><span class="action-owner">Owner: PMO</span> | <span class="action-due">Due: $(date -d "+3 days" +"%B %d")</span></div>
                </div>
                <div class="action-item">
                  <div>‚Ä¢ Authorize additional UI development budget ($25K) for Mobile App</div>  
                  <div><span class="action-owner">Owner: CFO</span> | <span class="action-due">Due: $(date -d "+2 days" +"%B %d")</span></div>
                </div>
                <div class="action-item">
                  <div>‚Ä¢ Review and approve scope change for Mobile App UI redesign</div>
                  <div><span class="action-owner">Owner: Executive Sponsor</span> | <span class="action-due">Due: $(date -d "+5 days" +"%B %d")</span></div>
                </div>
              </div>
              
              <!-- Links to Detailed Reports -->
              <div class="links-section">
                <h3>üîó Detailed Reports & Dashboards</h3>
                <div class="link-item">
                  <a href="${PROGRAM_DASHBOARD_URL}">üìä Program Dashboard (Real-time)</a>
                </div>
                <div class="link-item">
                  <a href="${DETAILED_REPORTS_URL}">üìà Individual Project Reports</a>
                </div>
                <div class="link-item">
                  <a href="https://github.com/${{ github.repository }}/issues?q=is%3Aissue+is%3Aopen+label%3Aprogram-risk">‚ö†Ô∏è Risk Register</a>
                </div>
                <div class="link-item">
                  <a href="https://github.com/${{ github.repository }}/milestones">üéØ Program Milestones</a>
                </div>
              </div>
              
              <!-- Metric Definitions -->
              <div class="metrics-definitions">
                <h4>üìñ Metric Definitions</h4>
                <div class="definition-item"><strong>RAG Status:</strong> üü¢ Green (On Track) | üü° Amber (At Risk) | üî¥ Red (Critical)</div>
                <div class="definition-item"><strong>Schedule Trend:</strong> ‚ñ≤ Ahead | ‚ñ∫ On Track | ‚ñº Behind</div>
                <div class="definition-item"><strong>Budget Trend:</strong> ‚ñ≤ Under Budget | ‚ñ∫ On Track | ‚ñº Over Budget</div>
              </div>
              
              <div class="footer">
                <p>Generated by Enhanced Program Status Workflow</p>
                <p><a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Workflow Run</a> | Questions? Reply to this email</p>
              </div>
            </div>
          </body>
          </html>
          EOF
          
          echo "email_file=email/program-status-email.html" >> $GITHUB_OUTPUT
          echo "‚úÖ Executive status email generated successfully"

      - name: üíæ Store Email Content
        run: |
          # Store email content for potential reuse
          git config --local user.email "action@github.com"
          git config --local user.name "Enhanced Program Status Automation"
          
          # Add the generated email
          git add email/
          
          # Commit if there are changes
          if ! git diff --staged --quiet; then
            git commit -m "üìß Generate program status email - $(date +"%B %d, %Y")"
            git push
          fi

  send-status-email:
    name: üìß Send Program Status Email
    needs: [collect-program-metrics, generate-executive-email]
    runs-on: ubuntu-latest
    # Only send email if not in test mode and email credentials are configured
    if: ${{ github.event.inputs.test_mode != 'true' && secrets.EMAIL_USERNAME != '' }}
    
    steps:
      - name: üì• Checkout Repository  
        uses: actions/checkout@v4

      - name: üîÑ Pull Latest Changes
        run: git pull origin main

      - name: üìß Send Enhanced Status Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER || 'smtp.gmail.com' }}
          server_port: ${{ secrets.SMTP_PORT || '465' }}
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "üìä Program ${{ github.event.inputs.program_name || 'Status' }} - Weekly Update $(date +'%B %d, %Y')"
          html_body: file://${{ needs.generate-executive-email.outputs.email_content }}
          to: ${{ env.MAIL_RECIPIENTS }}
          from: ${{ env.MAIL_FROM }}
          # Attachments (optional - add detailed reports)
          attachments: reports/status/weekly-status-$(date +%Y-%m-%d).md

      - name: ‚úÖ Email Delivery Confirmation
        run: |
          echo "‚úÖ Program status email sent successfully!"
          echo "üìß Recipients: ${{ env.MAIL_RECIPIENTS }}"
          echo "üìÖ Date: $(date)"
          echo "üè∑Ô∏è Program: ${{ github.event.inputs.program_name || 'Default Program' }}"

  # Optional: Generate Slack/Teams notification
  send-slack-notification:
    name: üí¨ Send Slack Notification
    needs: [collect-program-metrics, generate-executive-email]
    runs-on: ubuntu-latest
    if: ${{ secrets.SLACK_WEBHOOK_URL != '' }}
    
    steps:
      - name: üí¨ Send Slack Summary
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          PROGRAM_HEALTH: ${{ needs.collect-program-metrics.outputs.program_health }}
          OVERALL_COMPLETION: ${{ needs.collect-program-metrics.outputs.overall_completion }}
        run: |
          HEALTH_EMOJI="üü¢"
          if [ "$PROGRAM_HEALTH" = "AMBER" ]; then
            HEALTH_EMOJI="üü°"
          elif [ "$PROGRAM_HEALTH" = "RED" ]; then
            HEALTH_EMOJI="üî¥"
          fi
          
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\": \"üìä Program Status Update\",
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Program ${{ github.event.inputs.program_name || 'Status' }} Update*\\n${HEALTH_EMOJI} Overall Health: ${PROGRAM_HEALTH}\\nüìà Completion: ${OVERALL_COMPLETION}%\"
                  }
                },
                {
                  \"type\": \"actions\",
                  \"elements\": [
                    {
                      \"type\": \"button\",
                      \"text\": {
                        \"type\": \"plain_text\",
                        \"text\": \"View Full Report\"
                      },
                      \"url\": \"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
                    }
                  ]
                }
              ]
            }" \
            $SLACK_WEBHOOK_URL
