name: ðŸ”’ Dependency Security Scan

on:
  schedule:
    # Weekly Monday 6 AM UTC - comprehensive scan
    - cron: '0 6 * * 1'
  pull_request:
    paths: 
      - '**/package*.json'
      - '**/requirements*.txt'
      - '**/Pipfile*'
      - '**/composer.json'
      - '**/go.mod'
      - '**/Cargo.toml'
      - '.github/workflows/dependency-security.yml'
  push:
    branches: [main]
    paths:
      - '**/package*.json'
      - '**/requirements*.txt'
      - '**/Pipfile*'
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of dependency scan'
        required: true
        default: 'comprehensive'
        type: choice
        options:
          - comprehensive
          - vulnerability-only
          - license-only
          - outdated-packages

env:
  # Security scanning configuration
  VULNERABILITY_THRESHOLD: 'moderate'  # moderate, high, critical
  LICENSE_ALLOWLIST: 'MIT,Apache-2.0,BSD-3-Clause,ISC'

jobs:
  dependency-scan:
    name: Dependency Security Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      pull-requests: write
      actions: read

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Detect Project Languages
        id: detect-languages
        run: |
          # Detect which languages/package managers are present
          HAS_NODE=$([ -f package.json ] && echo "true" || echo "false")
          HAS_PYTHON=$([ -f requirements.txt ] || [ -f Pipfile ] && echo "true" || echo "false")
          HAS_COMPOSER=$([ -f composer.json ] && echo "true" || echo "false")
          HAS_GO=$([ -f go.mod ] && echo "true" || echo "false")
          HAS_RUST=$([ -f Cargo.toml ] && echo "true" || echo "false")
          
          echo "has_node=$HAS_NODE" >> $GITHUB_OUTPUT
          echo "has_python=$HAS_PYTHON" >> $GITHUB_OUTPUT
          echo "has_composer=$HAS_COMPOSER" >> $GITHUB_OUTPUT
          echo "has_go=$HAS_GO" >> $GITHUB_OUTPUT
          echo "has_rust=$HAS_RUST" >> $GITHUB_OUTPUT
          
          echo "ðŸ” Detected languages:"
          echo "- Node.js: $HAS_NODE"
          echo "- Python: $HAS_PYTHON"
          echo "- PHP: $HAS_COMPOSER"
          echo "- Go: $HAS_GO"
          echo "- Rust: $HAS_RUST"

      - name: ðŸ›¡ï¸ Run GitHub Dependency Review
        if: github.event_name == 'pull_request'
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: ${{ env.VULNERABILITY_THRESHOLD }}
          allow-licenses: ${{ env.LICENSE_ALLOWLIST }}
          base-ref: ${{ github.event.pull_request.base.sha }}
          head-ref: ${{ github.event.pull_request.head.sha }}

      - name: ðŸ“¦ Setup Node.js
        if: steps.detect-languages.outputs.has_node == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ” Node.js Security Audit
        if: steps.detect-languages.outputs.has_node == 'true'
        env:
          VULN_THRESHOLD: ${{ env.VULNERABILITY_THRESHOLD }}
        run: |
          echo "ðŸ” Running npm security audit..."
          
          # Install dependencies first
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi
          
          # Run audit with appropriate level
          if ! npm audit --audit-level="$VULN_THRESHOLD"; then
            echo "âŒ npm audit found vulnerabilities at or above $VULN_THRESHOLD level"
            
            # Generate detailed report
            npm audit --json > npm-audit-results.json || true
            
            # Create human-readable summary
            echo "## ðŸ”’ npm Audit Results" >> audit-summary.md
            echo "**Scan Date:** $(date)" >> audit-summary.md
            echo "**Threshold:** $VULN_THRESHOLD" >> audit-summary.md
            echo "" >> audit-summary.md
            
            # Extract summary from JSON
            if [ -f npm-audit-results.json ]; then
              jq -r '.metadata | "**Total Vulnerabilities:** \(.vulnerabilities.total // 0)\n**Info:** \(.vulnerabilities.info // 0)\n**Low:** \(.vulnerabilities.low // 0)\n**Moderate:** \(.vulnerabilities.moderate // 0)\n**High:** \(.vulnerabilities.high // 0)\n**Critical:** \(.vulnerabilities.critical // 0)"' npm-audit-results.json >> audit-summary.md
            fi
            
            exit 1
          else
            echo "âœ… npm audit passed - no vulnerabilities found at $VULN_THRESHOLD level or above"
          fi

      - name: ðŸ Setup Python
        if: steps.detect-languages.outputs.has_python == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ðŸ” Python Security Audit
        if: steps.detect-languages.outputs.has_python == 'true'
        run: |
          echo "ðŸ” Running Python security audit..."
          
          # Install safety for security scanning
          pip install safety pip-audit
          
          # Scan with safety (pyup.io database)
          if [ -f requirements.txt ]; then
            echo "ðŸ“‹ Scanning requirements.txt with safety..."
            safety check -r requirements.txt --json > safety-results.json || true
            
            echo "ðŸ“‹ Scanning with pip-audit..."
            pip-audit -r requirements.txt --format=json --output=pip-audit-results.json || true
          fi
          
          # Check Pipfile if present
          if [ -f Pipfile ]; then
            echo "ðŸ“‹ Installing pipenv and scanning Pipfile..."
            pip install pipenv
            pipenv check --json > pipenv-results.json || true
          fi
          
          echo "âœ… Python security audit completed"

      - name: ðŸ” SAST Scanning with Semgrep
        uses: semgrep/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/owasp-top-ten
            p/javascript
            p/python
          generateSarif: "1"
        env:
          SEMGREP_TIMEOUT: 300
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: ðŸ” Enhanced Secrets Detection
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

      - name: ðŸ“Š Generate Security Report
        if: always()
        env:
          GITHUB_REPO: ${{ github.repository }}
          SCAN_TYPE: ${{ github.event.inputs.scan_type || 'comprehensive' }}
          VULN_THRESHOLD: ${{ env.VULNERABILITY_THRESHOLD }}
        run: |
          # Create comprehensive security report
          mkdir -p security-reports
          
          cat > security-reports/dependency-security-report.md << EOF
          # ðŸ”’ Dependency Security Report
          
          **Generated:** $(date)
          **Repository:** $GITHUB_REPO
          **Scan Type:** $SCAN_TYPE
          **Threshold:** $VULN_THRESHOLD
          
          ## ðŸ“Š Scan Summary
          
          | Language | Scanned | Status |
          |----------|---------|--------|
          | Node.js | ${{ steps.detect-languages.outputs.has_node }} | $([ "${{ steps.detect-languages.outputs.has_node }}" = "true" ] && echo "âœ… Completed" || echo "â­ï¸ Skipped") |
          | Python | ${{ steps.detect-languages.outputs.has_python }} | $([ "${{ steps.detect-languages.outputs.has_python }}" = "true" ] && echo "âœ… Completed" || echo "â­ï¸ Skipped") |
          | SAST | Always | âœ… Completed |
          | Secrets | Always | âœ… Completed |
          
          ## ðŸ” Detailed Results
          
          ### Node.js Dependencies
          EOF
          
          # Add npm audit results if available
          if [ -f audit-summary.md ]; then
            cat audit-summary.md >> security-reports/dependency-security-report.md
          else
            echo "âœ… No npm vulnerabilities found" >> security-reports/dependency-security-report.md
          fi
          
          cat >> security-reports/dependency-security-report.md << EOF
          
          ### Python Dependencies
          EOF
          
          # Add Python results if available
          if [ -f safety-results.json ] && [ -s safety-results.json ]; then
            echo "âš ï¸ Safety scan found issues - see safety-results.json" >> security-reports/dependency-security-report.md
          else
            echo "âœ… No Python vulnerabilities found" >> security-reports/dependency-security-report.md
          fi
          
          cat >> security-reports/dependency-security-report.md << EOF
          
          ## ðŸ“‹ Recommendations
          
          1. **Regular Updates:** Keep dependencies updated to latest secure versions
          2. **Automated Scanning:** This workflow runs weekly and on dependency changes
          3. **Security Monitoring:** Monitor security advisories for your dependencies
          4. **Least Privilege:** Review and minimize dependency permissions
          
          ## ðŸ”„ Next Steps
          
          - Review any flagged vulnerabilities above
          - Update vulnerable dependencies to secure versions
          - Consider alternative packages if updates are not available
          - Add security headers and configurations as needed
          
          ---
          *Generated by Dependency Security Workflow*
          EOF

      - name: ðŸ“¤ Upload Security Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results-${{ github.run_number }}
          path: |
            security-reports/
            npm-audit-results.json
            safety-results.json
            pip-audit-results.json
            pipenv-results.json
          retention-days: 30
          if-no-files-found: warn

      - name: ðŸ’¬ Comment on Pull Request
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let commentBody = "## ðŸ”’ Dependency Security Scan Results\n\n";
            
            // Check if security report exists
            try {
              const report = fs.readFileSync('security-reports/dependency-security-report.md', 'utf8');
              const summary = report.split('## ðŸ“Š Scan Summary')[1]?.split('## ðŸ” Detailed Results')[0] || '';
              commentBody += summary;
            } catch (e) {
              commentBody += "Security scan completed. Check workflow logs for details.\n\n";
            }
            
            commentBody += `
            ### ðŸ›¡ï¸ Security Status
            - **Dependency Review:** âœ… Completed
            - **SAST Scanning:** âœ… Completed  
            - **Secrets Detection:** âœ… Completed
            - **Vulnerability Threshold:** ${{ env.VULNERABILITY_THRESHOLD }}
            
            ðŸ“„ [View Full Security Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

      - name: ðŸš¨ Create Security Issue for Critical Findings
        if: failure() && github.event_name == 'schedule'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create issue for critical security findings
          gh issue create \
            --title "ðŸš¨ Critical Security Vulnerabilities Detected" \
            --label "security,critical,vulnerability" \
            --body "## ðŸ”’ Security Alert
          
          **Detection Date:** $(date)
          **Workflow:** Dependency Security Scan
          **Severity:** Critical
          
          ### ðŸš¨ Action Required
          
          Critical security vulnerabilities have been detected in project dependencies.
          
          ### ðŸ“‹ Immediate Steps
          
          1. **Review** the security scan results in the workflow logs
          2. **Update** vulnerable dependencies to secure versions
          3. **Test** thoroughly after updates
          4. **Monitor** for any additional security advisories
          
          ### ðŸ“Š Scan Details
          
          - **Threshold:** ${{ env.VULNERABILITY_THRESHOLD }}
          - **Scan Type:** Comprehensive
          - **Workflow Run:** [View Details](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ---
          *Auto-generated by Security Scanning Workflow*"

      - name: ðŸŽ¯ Security Scan Summary
        if: always()
        env:
          SCAN_TYPE: ${{ github.event.inputs.scan_type || 'comprehensive' }}
          HAS_NODE: ${{ steps.detect-languages.outputs.has_node }}
          HAS_PYTHON: ${{ steps.detect-languages.outputs.has_python }}
          VULN_THRESHOLD: ${{ env.VULNERABILITY_THRESHOLD }}
        run: |
          echo "ðŸ”’ Dependency Security Scan Summary"
          echo "=================================="
          echo "Scan Type: $SCAN_TYPE"
          echo "Languages Detected:"
          echo "- Node.js: $HAS_NODE"
          echo "- Python: $HAS_PYTHON"
          echo "Vulnerability Threshold: $VULN_THRESHOLD"
          echo "Status: $([ $? -eq 0 ] && echo "âœ… Passed" || echo "âŒ Issues Found")"
          echo ""
          echo "ðŸ“‹ Security scanning completed successfully!"
          echo "ðŸ” Check artifacts for detailed results"
