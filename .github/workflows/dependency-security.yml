name: ðŸ”’ Dependency Security

on:
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of security scan'
        required: true
        default: 'basic'
        type: choice
        options:
          - basic
          - comprehensive
      scan_scope:
        description: 'Dependencies to scan'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - javascript
          - python
          - ruby

env:
  # Basic scanning configuration
  SEVERITY_THRESHOLD: medium
  TIMEOUT_MINUTES: 5

jobs:
  security-scan:
    name: ðŸ”’ Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: ${{ env.TIMEOUT_MINUTES }}
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ” Discover Dependencies
        id: discover
        run: |
          echo "ðŸ” Discovering project dependencies..."
          
          mkdir -p ./security-scan
          
          # Check for dependency files
          FOUND_FILES=()
          
          # JavaScript dependencies
          if [ -f "package.json" ]; then
            FOUND_FILES+=("javascript")
            cp package.json ./security-scan/
            [ -f "package-lock.json" ] && cp package-lock.json ./security-scan/
            [ -f "yarn.lock" ] && cp yarn.lock ./security-scan/
          fi
          
          # Python dependencies
          if [ -f "requirements.txt" ]; then
            FOUND_FILES+=("python")
            cp requirements.txt ./security-scan/
            [ -f "Pipfile" ] && cp Pipfile ./security-scan/
            [ -f "Pipfile.lock" ] && cp Pipfile.lock ./security-scan/
          fi
          
          # Ruby dependencies
          if [ -f "Gemfile" ]; then
            FOUND_FILES+=("ruby")
            cp Gemfile ./security-scan/
            [ -f "Gemfile.lock" ] && cp Gemfile.lock ./security-scan/
          fi
          
          # Generate report
          echo "Found dependencies: ${FOUND_FILES[@]:-none}"
          
          # Set output
          if [ ${#FOUND_FILES[@]} -eq 0 ]; then
            echo "found_dependencies=false" >> $GITHUB_OUTPUT
            echo "dependency_types=none" >> $GITHUB_OUTPUT
          else
            echo "found_dependencies=true" >> $GITHUB_OUTPUT
            echo "dependency_types=${FOUND_FILES[@]}" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ” Analyze Dependencies
        id: analyze
        if: steps.discover.outputs.found_dependencies == 'true'
        run: |
          echo "ðŸ” Analyzing dependencies..."
          SCAN_SCOPE="${{ github.event.inputs.scan_scope }}"
          
          analyze_javascript() {
            if [ -f "./security-scan/package.json" ]; then
              echo "ðŸ“¦ Analyzing JavaScript dependencies..."
              MAX_RETRIES=3
              RETRY_COUNT=0
              SUCCESS=false
              
              while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" != "true" ]; do
                echo "Attempt $((RETRY_COUNT + 1)) of $MAX_RETRIES for JavaScript analysis..."
                
                if [ -f "./security-scan/yarn.lock" ]; then
                  if yarn audit --json > javascript-audit.json 2>/dev/null; then
                    if jq -e '.' javascript-audit.json > /dev/null 2>&1; then
                      SUCCESS=true
                      echo "âœ… JavaScript analysis completed successfully"
                    fi
                  fi
                else
                  if npm audit --json > javascript-audit.json 2>/dev/null; then
                    if jq -e '.' javascript-audit.json > /dev/null 2>&1; then
                      SUCCESS=true
                      echo "âœ… JavaScript analysis completed successfully"
                    fi
                  fi
                fi
                
                if [ "$SUCCESS" != "true" ]; then
                  RETRY_COUNT=$((RETRY_COUNT + 1))
                  [ $RETRY_COUNT -lt $MAX_RETRIES ] && sleep 5
                fi
              done
              
              if [ "$SUCCESS" != "true" ]; then
                echo "âš ï¸ Failed to analyze JavaScript dependencies after $MAX_RETRIES attempts"
                echo '{"vulnerabilities":{}}' > javascript-audit.json
              fi
            fi
          }
          
          analyze_python() {
            if [ -f "./security-scan/requirements.txt" ]; then
              echo "ðŸ Analyzing Python dependencies..."
              pip install safety
              safety check -r ./security-scan/requirements.txt --json > python-audit.json || true
            fi
          }
          
          analyze_ruby() {
            if [ -f "./security-scan/Gemfile" ]; then
              echo "ðŸ’Ž Analyzing Ruby dependencies..."
              bundle audit update
              bundle audit check --format json > ruby-audit.json || true
            fi
          }
          
          # Run analyses based on scope
          if [ "$SCAN_SCOPE" = "all" ] || [ "$SCAN_SCOPE" = "javascript" ]; then
            analyze_javascript
          fi
          
          if [ "$SCAN_SCOPE" = "all" ] || [ "$SCAN_SCOPE" = "python" ]; then
            analyze_python
          fi
          
          if [ "$SCAN_SCOPE" = "all" ] || [ "$SCAN_SCOPE" = "ruby" ]; then
            analyze_ruby
          fi
          
          # Process results and generate summary
          python3 - << 'EOF'
          import json
          import os
          from datetime import datetime
          
          def process_javascript_audit(file_path):
              try:
                  with open(file_path) as f:
                      data = json.load(f)
                  return len(data.get('vulnerabilities', {}))
              except:
                  return 0
          
          def process_python_audit(file_path):
              try:
                  with open(file_path) as f:
                      data = json.load(f)
                  return len(data)
              except:
                  return 0
          
          def process_ruby_audit(file_path):
              try:
                  with open(file_path) as f:
                      data = json.load(f)
                  return len(data.get('vulnerabilities', []))
              except:
                  return 0
          
          report = {
              'timestamp': datetime.now().isoformat(),
              'summary': {
                  'total_vulnerabilities': 0,
                  'by_language': {}
              }
          }
          
          # Process JavaScript
          if os.path.exists('javascript-audit.json'):
              js_vulns = process_javascript_audit('javascript-audit.json')
              report['summary']['by_language']['javascript'] = js_vulns
              report['summary']['total_vulnerabilities'] += js_vulns
          
          # Process Python
          if os.path.exists('python-audit.json'):
              py_vulns = process_python_audit('python-audit.json')
              report['summary']['by_language']['python'] = py_vulns
              report['summary']['total_vulnerabilities'] += py_vulns
          
          # Process Ruby
          if os.path.exists('ruby-audit.json'):
              rb_vulns = process_ruby_audit('ruby-audit.json')
              report['summary']['by_language']['ruby'] = rb_vulns
              report['summary']['total_vulnerabilities'] += rb_vulns
          
          # Save report
          with open('security-report.json', 'w') as f:
              json.dump(report, f, indent=2)
          
          # Print summary
          total = report['summary']['total_vulnerabilities']
          by_lang = report['summary']['by_language']
          
          print(f"Found {total} total vulnerabilities:")
          for lang, count in by_lang.items():
              print(f"- {lang}: {count} vulnerabilities")
          EOF

      - name: ðŸ“¤ Upload Scan Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-${{ github.run_number }}
          path: |
            *.json
            ./security-scan/
          retention-days: 30

      - name: ðŸš¨ Create Security Alert
        if: steps.analyze.outputs.total_vulnerabilities > 0
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TOTAL_VULNS=$(jq -r '.summary.total_vulnerabilities' security-report.json)
          
          if [ "$TOTAL_VULNS" -gt 0 ]; then
            TITLE="ðŸš¨ Security Alert: Found $TOTAL_VULNS vulnerable dependencies"
            
            # Generate alert body
            BODY="## ðŸ”’ Dependency Security Alert
            
            **Scan Details:**
            - Repository: ${{ github.repository }}
            - Scan Type: ${{ github.event.inputs.scan_type }}
            - Scan Scope: ${{ github.event.inputs.scan_scope }}
            - Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
            
            ### ðŸ“Š Vulnerability Summary
            $(jq -r '.summary.by_language | to_entries[] | "- **\(.key)**: \(.value) vulnerabilities"' security-report.json)
            
            ### ðŸ” Next Steps
            1. Review the detailed scan results in workflow artifacts
            2. Update vulnerable dependencies
            3. Re-run security scan to verify fixes
            
            ### ðŸ“ Resources
            - [Scan Results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [Security Best Practices](https://docs.github.com/en/code-security)
            
            ---
            *This alert was automatically generated by the Dependency Security workflow*"
            
            # Create issue
            gh issue create --title "$TITLE" --body "$BODY" --label "security,dependencies,alert"
          fi
          # ðŸ”’ Dependency Security Report
          
          **Generated:** $(date)
          **Repository:** $GITHUB_REPO
          **Scan Type:** $SCAN_TYPE
          **Threshold:** $VULN_THRESHOLD
          
          ## ðŸ“Š Scan Summary
          
          | Language | Scanned | Status |
          |----------|---------|--------|
          | Node.js | ${{ steps.detect-languages.outputs.has_node }} | $([ "${{ steps.detect-languages.outputs.has_node }}" = "true" ] && echo "âœ… Completed" || echo "â­ï¸ Skipped") |
          | Python | ${{ steps.detect-languages.outputs.has_python }} | $([ "${{ steps.detect-languages.outputs.has_python }}" = "true" ] && echo "âœ… Completed" || echo "â­ï¸ Skipped") |
          | SAST | Always | âœ… Completed |
          | Secrets | Always | âœ… Completed |
          
          ## ðŸ” Detailed Results
          
          ### Node.js Dependencies
          EOF
          
          # Add npm audit results if available
          if [ -f audit-summary.md ]; then
            cat audit-summary.md >> security-reports/dependency-security-report.md
          else
            echo "âœ… No npm vulnerabilities found" >> security-reports/dependency-security-report.md
          fi
          
          cat >> security-reports/dependency-security-report.md << EOF
          
          ### Python Dependencies
          EOF
          
          # Add Python results if available
          if [ -f safety-results.json ] && [ -s safety-results.json ]; then
            echo "âš ï¸ Safety scan found issues - see safety-results.json" >> security-reports/dependency-security-report.md
          else
            echo "âœ… No Python vulnerabilities found" >> security-reports/dependency-security-report.md
          fi
          
          cat >> security-reports/dependency-security-report.md << EOF
          
          ## ðŸ“‹ Recommendations
          
          1. **Regular Updates:** Keep dependencies updated to latest secure versions
          2. **Automated Scanning:** This workflow runs weekly and on dependency changes
          3. **Security Monitoring:** Monitor security advisories for your dependencies
          4. **Least Privilege:** Review and minimize dependency permissions
          
          ## ðŸ”„ Next Steps
          
          - Review any flagged vulnerabilities above
          - Update vulnerable dependencies to secure versions
          - Consider alternative packages if updates are not available
          - Add security headers and configurations as needed
          
          ---
          *Generated by Dependency Security Workflow*
          EOF

      - name: ðŸ“¤ Upload Security Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results-${{ github.run_number }}
          path: |
            security-reports/
            npm-audit-results.json
            safety-results.json
            pip-audit-results.json
            pipenv-results.json
          retention-days: 30
          if-no-files-found: warn

      - name: ðŸ’¬ Comment on Pull Request
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let commentBody = "## ðŸ”’ Dependency Security Scan Results\n\n";
            
            // Check if security report exists
            try {
              const report = fs.readFileSync('security-reports/dependency-security-report.md', 'utf8');
              const summary = report.split('## ðŸ“Š Scan Summary')[1]?.split('## ðŸ” Detailed Results')[0] || '';
              commentBody += summary;
            } catch (e) {
              commentBody += "Security scan completed. Check workflow logs for details.\n\n";
            }
            
            commentBody += `
            ### ðŸ›¡ï¸ Security Status
            - **Dependency Review:** âœ… Completed
            - **SAST Scanning:** âœ… Completed  
            - **Secrets Detection:** âœ… Completed
            - **Vulnerability Threshold:** ${{ env.VULNERABILITY_THRESHOLD }}
            
            ðŸ“„ [View Full Security Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

      - name: ðŸš¨ Create Security Issue for Critical Findings
        if: failure() && github.event_name == 'schedule'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create issue for critical security findings
          gh issue create \
            --title "ðŸš¨ Critical Security Vulnerabilities Detected" \
            --label "security,critical,vulnerability" \
            --body "## ðŸ”’ Security Alert
          
          **Detection Date:** $(date)
          **Workflow:** Dependency Security Scan
          **Severity:** Critical
          
          ### ðŸš¨ Action Required
          
          Critical security vulnerabilities have been detected in project dependencies.
          
          ### ðŸ“‹ Immediate Steps
          
          1. **Review** the security scan results in the workflow logs
          2. **Update** vulnerable dependencies to secure versions
          3. **Test** thoroughly after updates
          4. **Monitor** for any additional security advisories
          
          ### ðŸ“Š Scan Details
          
          - **Threshold:** ${{ env.VULNERABILITY_THRESHOLD }}
          - **Scan Type:** Comprehensive
          - **Workflow Run:** [View Details](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ---
          *Auto-generated by Security Scanning Workflow*"

      - name: ðŸŽ¯ Security Scan Summary
        if: always()
        env:
          SCAN_TYPE: ${{ github.event.inputs.scan_type || 'comprehensive' }}
          HAS_NODE: ${{ steps.detect-languages.outputs.has_node }}
          HAS_PYTHON: ${{ steps.detect-languages.outputs.has_python }}
          VULN_THRESHOLD: ${{ env.VULNERABILITY_THRESHOLD }}
        run: |
          echo "ðŸ”’ Dependency Security Scan Summary"
          echo "=================================="
          echo "Scan Type: $SCAN_TYPE"
          echo "Languages Detected:"
          echo "- Node.js: $HAS_NODE"
          echo "- Python: $HAS_PYTHON"
          echo "Vulnerability Threshold: $VULN_THRESHOLD"
          echo "Status: $([ $? -eq 0 ] && echo "âœ… Passed" || echo "âŒ Issues Found")"
          echo ""
          echo "ðŸ“‹ Security scanning completed successfully!"
          echo "ðŸ” Check artifacts for detailed results"
