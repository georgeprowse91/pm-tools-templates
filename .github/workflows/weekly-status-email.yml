name: Weekly Status Email

on:
  schedule:
    - cron: '0 16 * * 5'
    - cron: '0 7 * * 1'
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Run in test mode'
        required: false
        default: 'true'
        type: boolean
      report_type:
        description: 'Type of status report'
        required: true
        default: 'weekly'
        type: choice
        options:
          - weekly
          - monthly
          - sprint
          - milestone
      methodology:
        description: 'Project methodology'
        required: false
        default: 'agile'
        type: choice
        options:
          - agile
          - traditional
          - hybrid

env:
  MAIL_RECIPIENTS: project-team@example.com, stakeholders@example.com
  MAIL_FROM: project-status@example.com

jobs:
  status-reporting:
    name: Generate Status Report
    runs-on: ubuntu-latest
    outputs:
      completion_rate: ${{ steps.metrics.outputs.completion_rate }}
      strategic_progress: ${{ steps.metrics.outputs.strategic_progress }}
      critical_risks: ${{ steps.metrics.outputs.critical_risks }}
      high_priority: ${{ steps.metrics.outputs.high_priority }}
    permissions:
      contents: read
      issues: read
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Collect Project Metrics
        id: metrics
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Collecting project metrics..."
          
          # Issue metrics
          TOTAL_ISSUES=$(gh issue list --state all --json number | jq length)
          OPEN_ISSUES=$(gh issue list --state open --json number | jq length)
          CLOSED_ISSUES=$(gh issue list --state closed --json number | jq length)
          HIGH_PRIORITY=$(gh issue list --label "high-priority" --state open --json number | jq length)
          
          # Calculate completion rate
          if [ $TOTAL_ISSUES -gt 0 ]; then
            COMPLETION_RATE=$(( CLOSED_ISSUES * 100 / TOTAL_ISSUES ))
          else
            COMPLETION_RATE=0
          fi
          
          # Strategic metrics (simplified)
          STRATEGIC_PROGRESS=75
          CRITICAL_RISKS=0
          
          # Store outputs
          echo "completion_rate=$COMPLETION_RATE" >> $GITHUB_OUTPUT
          echo "strategic_progress=$STRATEGIC_PROGRESS" >> $GITHUB_OUTPUT
          echo "critical_risks=$CRITICAL_RISKS" >> $GITHUB_OUTPUT
          echo "high_priority=$HIGH_PRIORITY" >> $GITHUB_OUTPUT
          
          echo "Metrics collected:"
          echo "- Total Issues: $TOTAL_ISSUES"
          echo "- Completion Rate: $COMPLETION_RATE%"
          echo "- High Priority: $HIGH_PRIORITY"

  send-email:
    name: Send Status Email
    needs: status-reporting
    if: always() && needs.status-reporting.result == 'success'
    runs-on: ubuntu-latest
    env:
      COMPLETION_RATE: ${{ needs.status-reporting.outputs.completion_rate }}
      STRATEGIC_PROGRESS: ${{ needs.status-reporting.outputs.strategic_progress }}
      CRITICAL_RISKS: ${{ needs.status-reporting.outputs.critical_risks }}
      HIGH_PRIORITY: ${{ needs.status-reporting.outputs.high_priority }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Generate Simple Email
        run: |
          mkdir -p ./email
          
          cat > ./email/status-email.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>Weekly Status Update</title>
          </head>
          <body style="font-family: Arial, sans-serif; margin: 20px;">
            <h1>Weekly Project Status Update</h1>
            <p>Generated on $(date)</p>
            
            <h2>Key Metrics</h2>
            <ul>
              <li>Completion Rate: ${COMPLETION_RATE}%</li>
              <li>Strategic Progress: ${STRATEGIC_PROGRESS}%</li>
              <li>High Priority Items: ${HIGH_PRIORITY}</li>
              <li>Critical Risks: ${CRITICAL_RISKS}</li>
            </ul>
            
            <p>This is a test email from your GitHub Actions workflow.</p>
          </body>
          </html>
          EOF

      - name: Send Status Email
        if: ${{ secrets.EMAIL_USERNAME != '' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "Weekly Project Status Update - $(date +\"%B %d, %Y\")"
          html_body: file://./email/status-email.html
          to: ${{ secrets.EMAIL_RECIPIENTS || env.MAIL_RECIPIENTS }}
          from: ${{ secrets.EMAIL_FROM || env.MAIL_FROM }}
          content_type: text/html
          
      - name: Email Status Report
        run: |
          if [ "${{ secrets.EMAIL_USERNAME }}" != "" ]; then
            echo "‚úÖ Weekly status email sent successfully!"
            echo "üìß Sent to: ${{ secrets.EMAIL_RECIPIENTS || env.MAIL_RECIPIENTS }}"
            echo "üìä Content: Project metrics and status report"
            echo "üìà Completion Rate: ${COMPLETION_RATE}%"
            echo "üéØ High Priority Items: ${HIGH_PRIORITY}"
            echo "‚ö†Ô∏è  Critical Risks: ${CRITICAL_RISKS}"
          else
            echo "‚ùå EMAIL_USERNAME secret not configured - email not sent"
          fi
          
          echo "\nEmail content preview:"
          cat ./email/status-email.html
