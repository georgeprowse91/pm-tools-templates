name: ðŸ§ª Test Minimal Status Email

on:
  workflow_dispatch:  # Allow manual trigger
    inputs:
      test_email:
        description: 'Test recipient email'
        required: false
        default: 'mirichard77@gmail.com'

jobs:
  test-status-email:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“‹ Checkout Code
      uses: actions/checkout@v4
    
    - name: ðŸ“Š Collect Basic Metrics
      id: metrics
      run: |
        echo "Collecting basic repository metrics..."
        
        # Simple counts
        total_issues=$(curl -s "https://api.github.com/repos/$GITHUB_REPOSITORY/issues?state=all&per_page=1" | jq -r '. | length')
        open_issues=$(curl -s "https://api.github.com/repos/$GITHUB_REPOSITORY/issues?state=open&per_page=100" | jq -r '. | length')
        closed_issues=$((total_issues - open_issues))
        
        # Calculate basic completion percentage
        if [ $total_issues -gt 0 ]; then
          completion_pct=$((closed_issues * 100 / total_issues))
        else
          completion_pct=100
        fi
        
        # Export for email template
        echo "TOTAL_ISSUES=$total_issues" >> $GITHUB_ENV
        echo "OPEN_ISSUES=$open_issues" >> $GITHUB_ENV
        echo "CLOSED_ISSUES=$closed_issues" >> $GITHUB_ENV
        echo "COMPLETION_PCT=$completion_pct" >> $GITHUB_ENV
        echo "CURRENT_DATE=$(date '+%Y-%m-%d')" >> $GITHUB_ENV
        
        echo "âœ… Metrics collected: $total_issues total, $open_issues open, $completion_pct% complete"
    
    - name: ðŸ“§ Send Test Status Email
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "ðŸ§ª Test - PM Tools Status Update (${{ env.CURRENT_DATE }})"
        to: ${{ github.event.inputs.test_email }}
        from: ${{ secrets.EMAIL_USERNAME }}
        html_body: |
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Test Status Update</title>
            <style>
              body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px; }
              .header { background: #4CAF50; color: white; padding: 20px; text-align: center; border-radius: 8px; }
              .metric { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
              .metric-value { font-size: 24px; font-weight: bold; color: #4CAF50; }
              .footer { margin-top: 20px; text-align: center; color: #666; font-size: 12px; }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>ðŸ§ª Test Status Update</h1>
              <p>Minimal Workflow Test - ${{ env.CURRENT_DATE }}</p>
            </div>
            
            <h2>ðŸ“Š Basic Metrics</h2>
            <div class="metric">
              <strong>Total Issues:</strong> <span class="metric-value">${{ env.TOTAL_ISSUES }}</span>
            </div>
            <div class="metric">
              <strong>Open Issues:</strong> <span class="metric-value">${{ env.OPEN_ISSUES }}</span>
            </div>
            <div class="metric">
              <strong>Closed Issues:</strong> <span class="metric-value">${{ env.CLOSED_ISSUES }}</span>
            </div>
            <div class="metric">
              <strong>Completion:</strong> <span class="metric-value">${{ env.COMPLETION_PCT }}%</span>
            </div>
            
            <h2>âœ… Test Results</h2>
            <div class="metric">
              <p>âœ… Repository metrics collected successfully</p>
              <p>âœ… Email template rendered successfully</p>
              <p>âœ… GitHub Actions workflow executed successfully</p>
            </div>
            
            <div class="footer">
              <p>ðŸ¤– Generated by GitHub Actions</p>
              <p>ðŸ§ª This is a minimal test of the status email system</p>
              <p>Repository: ${{ github.repository }}</p>
              <p>Workflow: ${{ github.workflow }}</p>
              <p>Run ID: ${{ github.run_id }}</p>
            </div>
          </body>
          </html>
