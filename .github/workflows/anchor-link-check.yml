name: Anchor Link Check

on:
  # Run on pull requests
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**/*.md'
      - '.github/workflows/anchor-link-check.yml'
      - 'check_anchor_links.py'
      - 'quick_anchor_check.sh'

  # Run on pushes to main branch
  push:
    branches: [ main ]
    paths:
      - '**/*.md'
      - '.github/workflows/anchor-link-check.yml'
      - 'check_anchor_links.py'
      - 'quick_anchor_check.sh'

  # Allow manual triggering
  workflow_dispatch:
    inputs:
      auto_fix:
        description: 'Auto-fix issues (will create a commit)'
        required: false
        default: 'false'
        type: boolean

jobs:
  anchor-link-check:
    name: Check Anchor Links
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Needed for auto-fix commits
      pull-requests: write  # Needed for PR comments
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch full history for proper diff analysis
          fetch-depth: 0
          # Use PAT for auto-fix commits to trigger other workflows
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Make scripts executable
        run: |
          chmod +x quick_anchor_check.sh
          chmod +x check_anchor_links.py

      - name: Quick anchor check
        id: quick_check
        run: |
          echo "Running quick anchor link check..."
          ./quick_anchor_check.sh > quick_check_output.txt 2>&1 || echo "Quick check found issues"
          
          # Capture exit code and output for later steps
          QUICK_EXIT_CODE=$?
          echo "quick_exit_code=$QUICK_EXIT_CODE" >> $GITHUB_OUTPUT
          
          # Show output
          cat quick_check_output.txt

      - name: Comprehensive anchor check
        id: full_check
        env:
          AUTO_FIX_INPUT: ${{ github.event.inputs.auto_fix }}
          GITHUB_REF: ${{ github.ref }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
        run: |
          echo "Running comprehensive anchor link analysis..."
          
          # Determine if we should auto-fix
          AUTO_FIX_FLAG=""
          if [[ "$AUTO_FIX_INPUT" == "true" ]] || [[ "$GITHUB_REF" == "refs/heads/main" && "$GITHUB_EVENT_NAME" == "push" ]]; then
            echo "Auto-fix enabled"
            AUTO_FIX_FLAG="--auto-fix"
          fi
          
          # Run the filtered comprehensive check (excludes node_modules)
          python check_anchor_links_filtered.py > full_check_output.txt 2>&1 || echo "Full check found issues"
          
          # Capture exit code
          FULL_EXIT_CODE=$?
          echo "full_exit_code=$FULL_EXIT_CODE" >> $GITHUB_OUTPUT
          
          # Show output
          cat full_check_output.txt

      - name: Upload anchor link report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: anchor-link-report
          path: |
            anchor_report.json
            quick_check_output.txt
            full_check_output.txt
          retention-days: 30

      - name: Create or update PR comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read check outputs
            let quickOutput = '';
            let fullOutput = '';
            let reportData = null;
            
            try {
              quickOutput = fs.readFileSync('quick_check_output.txt', 'utf8');
            } catch (e) {
              quickOutput = 'Quick check output not available';
            }
            
            try {
              fullOutput = fs.readFileSync('full_check_output.txt', 'utf8');
            } catch (e) {
              fullOutput = 'Full check output not available';
            }
            
            try {
              reportData = JSON.parse(fs.readFileSync('anchor_report.json', 'utf8'));
            } catch (e) {
              reportData = null;
            }
            
            // Determine overall status
            const quickExitCode = ${{ steps.quick_check.outputs.quick_exit_code }};
            const fullExitCode = ${{ steps.full_check.outputs.full_exit_code }};
            
            let status = '‚úÖ All anchor links are working correctly!';
            let statusIcon = '‚úÖ';
            
            if (fullExitCode === 1) {
              status = '‚ùå Critical anchor link issues found that need attention';
              statusIcon = '‚ùå';
            } else if (quickExitCode === 2 || fullExitCode === 2) {
              status = '‚ö†Ô∏è Potential anchor link improvements available';
              statusIcon = '‚ö†Ô∏è';
            }
            
            // Build comment body
            let commentBody = `## ${statusIcon} Anchor Link Check Results\n\n`;
            commentBody += `**Status:** ${status}\n\n`;
            
            if (reportData) {
              const summary = reportData.summary;
              commentBody += `### üìä Summary\n`;
              commentBody += `- **Files checked:** ${summary.total_files_checked}\n`;
              commentBody += `- **Total issues:** ${summary.total_issues}\n`;
              commentBody += `- **Broken links:** ${summary.broken_links}\n`;
              commentBody += `- **Suggestions:** ${summary.suggestions}\n`;
              commentBody += `- **Auto-fixable:** ${summary.auto_fixable}\n\n`;
              
              if (summary.broken_links > 0) {
                commentBody += `### ‚ùå Critical Issues\n`;
                commentBody += `Found ${summary.broken_links} broken anchor links that need immediate attention.\n\n`;
              }
              
              if (summary.suggestions > 0) {
                commentBody += `### üí° Suggestions\n`;
                commentBody += `Found ${summary.suggestions} headers that could benefit from explicit anchor tags.\n\n`;
              }
            }
            
            if (fullExitCode !== 0) {
              commentBody += `### üîß How to Fix\n`;
              commentBody += `Run the following command locally to auto-fix most issues:\n`;
              commentBody += '```bash\n';
              commentBody += 'python check_anchor_links.py --auto-fix\n';
              commentBody += '```\n\n';
            }
            
            commentBody += `<details>\n<summary>üìã Detailed Output</summary>\n\n`;
            commentBody += '### Quick Check\n```\n';
            commentBody += quickOutput.slice(0, 2000); // Limit length
            commentBody += '\n```\n\n';
            commentBody += '### Full Analysis\n```\n';
            commentBody += fullOutput.slice(0, 2000); // Limit length
            commentBody += '\n```\n</details>';
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Anchor Link Check Results')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }

      - name: Commit auto-fixes
        if: |
          (github.event.inputs.auto_fix == 'true' || 
           (github.ref == 'refs/heads/main' && github.event_name == 'push')) &&
          steps.full_check.outputs.full_exit_code == '0'
        run: |
          # Check if there are any changes to commit
          if ! git diff --quiet; then
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add -A
            git commit -m "Auto-fix anchor links
            
            - Added explicit HTML anchor tags for headers with special characters
            - Fixed broken anchor link references
            - Applied by automated anchor link maintenance system"
            git push
            echo "‚úÖ Auto-fixes committed and pushed"
          else
            echo "‚ÑπÔ∏è No changes to commit"
          fi

      - name: Fail on critical issues
        if: steps.full_check.outputs.full_exit_code == '1'
        run: |
          echo "‚ùå Critical anchor link issues found!"
          echo "Please run 'python check_anchor_links.py --auto-fix' to resolve them."
          exit 1

      - name: Summary
        if: always()
        run: |
          echo "üèÅ Anchor Link Check Complete"
          echo "================================"
          echo "Quick check exit code: ${{ steps.quick_check.outputs.quick_exit_code }}"
          echo "Full check exit code: ${{ steps.full_check.outputs.full_exit_code }}"
          
          if [[ "${{ steps.full_check.outputs.full_exit_code }}" == "0" ]]; then
            echo "‚úÖ All anchor links are working correctly!"
          elif [[ "${{ steps.full_check.outputs.full_exit_code }}" == "1" ]]; then
            echo "‚ùå Critical issues found - check the report for details"
          else
            echo "‚ö†Ô∏è Warnings or suggestions available - check the report"
          fi


