name: ðŸ” Verify Task Completion Claims

on:
  workflow_dispatch:
    inputs:
      task_description:
        description: 'Task being verified'
        required: true
        type: string
      claimed_status:
        description: 'Claimed completion status'
        required: true
        type: choice
        options:
          - COMPLETE
          - INCOMPLETE
          - PENDING_USER_CONFIRMATION

jobs:
  verify-completion:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“‹ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: ðŸ” Run Verification Checks
        id: verify
        run: |
          echo "ðŸ” Verifying task completion claim..."
          echo "Task: ${{ github.event.inputs.task_description }}"
          echo "Claimed Status: ${{ github.event.inputs.claimed_status }}"
          
          # Check if proper evidence exists
          EVIDENCE_FOUND=false
          
          # Look for recent workflow runs as evidence
          if gh run list --limit 5 --json conclusion,name | jq -r '.[] | select(.conclusion == "success") | .name' | wc -l | grep -v '^0$'; then
            echo "âœ… Found successful workflow runs as evidence"
            EVIDENCE_FOUND=true
          fi
          
          # Check for recent commits with verification
          if git log --oneline -5 | grep -iE "(verify|test|fix|complete)"; then
            echo "âœ… Found recent commits with verification keywords"
            EVIDENCE_FOUND=true
          fi
          
          # Verification result
          if [ "$EVIDENCE_FOUND" = true ] && [ "${{ github.event.inputs.claimed_status }}" = "COMPLETE" ]; then
            echo "âœ… VERIFICATION PASSED: Evidence supports completion claim"
            echo "verification_status=VERIFIED" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.claimed_status }}" != "COMPLETE" ]; then
            echo "â³ STATUS ACKNOWLEDGED: Task marked as ${{ github.event.inputs.claimed_status }}"
            echo "verification_status=ACKNOWLEDGED" >> $GITHUB_OUTPUT
          else
            echo "âŒ VERIFICATION FAILED: No evidence found for completion claim"
            echo "verification_status=FAILED" >> $GITHUB_OUTPUT
            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ“Š Generate Verification Report
        run: |
          mkdir -p verification-reports
          cat > "verification-reports/task-verification-$(date +%Y%m%d-%H%M%S).md" << EOF
          # Task Verification Report
          
          **Date:** $(date)
          **Task:** ${{ github.event.inputs.task_description }}
          **Claimed Status:** ${{ github.event.inputs.claimed_status }}
          **Verification Result:** ${{ steps.verify.outputs.verification_status }}
          
          ## Evidence Checked:
          - Recent workflow runs
          - Recent commits
          - Repository state
          
          ## Verification Status:
          ${{ steps.verify.outputs.verification_status == 'VERIFIED' && 'âœ… **VERIFIED** - Evidence supports completion claim' || steps.verify.outputs.verification_status == 'ACKNOWLEDGED' && 'â³ **ACKNOWLEDGED** - Non-complete status noted' || 'âŒ **FAILED** - No evidence for completion claim' }}
          
          ---
          *Generated by Verification Enforcement Workflow*
          EOF
          
          echo "ðŸ“‹ Verification report generated"
