name: Expert Review Process

on:
  issues:
    types: [opened, labeled]
  issue_comment:
    types: [created]

jobs:
  automated-validation:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Run Template Validation
        run: |
          echo "Running comprehensive template validation..."
          
          # Run validation on changed template files (fallback to all md if diff not available)
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E '\\.(md|markdown)$' || true)
          if [ -z "$CHANGED_FILES" ]; then
            CHANGED_FILES=$(git ls-files "**/*.md" "**/*.markdown" | head -n 50)
          fi
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "No template files to validate."
            exit 0
          fi
          
          VALIDATION_FAILED=false
          for file in $CHANGED_FILES; do
            if [ -f "$file" ]; then
              echo "Validating: $file"
              # Basic lint: ensure file has a title and at least 50 chars
              TITLE_OK=$(grep -E "^# " "$file" | head -n1 | wc -c | tr -d ' ')
              SIZE_OK=$(wc -c < "$file")
              if [ "${TITLE_OK:-0}" -eq 0 ] || [ "${SIZE_OK:-0}" -lt 50 ]; then
                VALIDATION_FAILED=true
                echo "âŒ Validation failed for: $file (missing title or too short)"
              else
                echo "âœ… Validation passed for: $file"
              fi
            fi
          done
          
          if [ "$VALIDATION_FAILED" = true ]; then
            echo "âŒ One or more templates failed validation"
            exit 1
          else
            echo "âœ… All templates passed validation"
            exit 0
          fi

  assign-peer-reviewers:
    if: github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'peer-review-needed'
    runs-on: ubuntu-latest
    steps:
      - name: Assign Peer Reviewers
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const reviewers = ['mirichard'];
            await github.rest.issues.addAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              assignees: reviewers
            });

  expert-review-assignment:
    if: >
      github.event_name == 'issues' && (
        github.event.action == 'opened' ||
        (github.event.action == 'labeled' && github.event.label.name == 'expert-review-needed')
      )
    runs-on: ubuntu-latest
    steps:
      - name: Assign Expert Reviewers
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.payload.issue.number;
            const issueBody = context.payload.issue.body || '';
            const issueTitle = context.payload.issue.title || '';
            
            // Define expert categories and their GitHub usernames
            const expertCategories = {
              'Agile/Scrum Templates': ['@mirichard'],
              'Traditional/Waterfall Templates': ['@mirichard'],
              'Hybrid Methodology Templates': ['@mirichard'],
              'Industry-Specific Templates': ['@mirichard'],
              'Role-Based Toolkits': ['@mirichard'],
              'Integration Templates': ['@mirichard']
            };
            
            // Determine category from issue content
            let assignedCategory = 'General';
            let experts = ['@mirichard']; // Default expert
            
            for (const [category, categoryExperts] of Object.entries(expertCategories)) {
              if (issueBody.includes(category) || issueTitle.includes(category)) {
                assignedCategory = category;
                experts = categoryExperts;
                break;
              }
            }
            
            const reviewComment = `
            ## ðŸ‘¨â€ðŸ’¼ Expert Review Assignment
            
            This ${context.payload.issue.labels.some(l => l.name === 'template-improvement') ? 'template improvement' : 'feedback item'} has been assigned for expert review.
            
            **Category:** ${assignedCategory}
            **Assigned Experts:** ${experts.join(', ')}
            
            Please proceed with the expert review guidelines.
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: reviewComment
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['expert-review-active']
            });

  process-expert-reviews:
    if: >
      github.event_name == 'issue_comment' && 
      contains(github.event.issue.labels.*.name, 'expert-review-active')
    runs-on: ubuntu-latest
    steps:
      - name: Process Expert Review Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const comment = context.payload.comment.body;
            const issueNumber = context.payload.issue.number;
            
            // Check if this is an expert review comment
            if (comment.includes('## Expert Review:')) {
              // Extract fields (optional)
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['expert-reviewed']
              });
            }
              // Remove needs-expert-input label
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  name: 'needs-expert-input'
                });
              } catch (error) {
                console.log('Label removal failed (may not exist):', error.message);
              }
            }
