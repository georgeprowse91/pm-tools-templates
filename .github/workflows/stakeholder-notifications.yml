name: üìß Stakeholder Notification System

on:
  issues:
    types: [opened, closed, labeled]
  milestone:
    types: [created, closed, opened]
  pull_request:
    types: [opened, merged, closed]
  schedule:
    # Weekly stakeholder digest every Friday at 5 PM UTC
    - cron: '0 17 * * 5'
  workflow_dispatch:
    inputs:
      notification_type:
        description: 'Type of notification to send'
        required: true
        default: 'weekly-digest'
        type: choice
        options:
          - weekly-digest
          - milestone-update
          - critical-alert
          - project-summary

env:
  STAKEHOLDER_GROUPS: "executives,project-managers,team-leads,business-users"

jobs:
  stakeholder-notifications:
    name: Stakeholder Notifications
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: read

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üìä Collect Stakeholder Data
        id: stakeholder-data
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Collect key metrics for stakeholder communication
          
          # Project health metrics
          TOTAL_ISSUES=$(gh issue list --state all --json number | jq length)
          OPEN_ISSUES=$(gh issue list --state open --json number | jq length)
          CLOSED_THIS_WEEK=$(gh issue list --state closed --json number,closedAt --jq '[.[] | select(.closedAt | fromdateiso8601 > (now - 604800))] | length')
          
          # Critical items requiring attention
          CRITICAL_ISSUES=$(gh issue list --label "critical" --state open --json number | jq length)
          HIGH_PRIORITY=$(gh issue list --label "high-priority" --state open --json number | jq length)
          BLOCKERS=$(gh issue list --label "blocker" --state open --json number | jq length)
          
          # Progress metrics
          if [ $TOTAL_ISSUES -gt 0 ]; then
            COMPLETION_RATE=$(( (TOTAL_ISSUES - OPEN_ISSUES) * 100 / TOTAL_ISSUES ))
          else
            COMPLETION_RATE=0
          fi
          
          # Risk assessment
          RISK_SCORE=$(( CRITICAL_ISSUES * 25 + HIGH_PRIORITY * 15 + BLOCKERS * 10 ))
          
          # Milestone progress
          UPCOMING_MILESTONES=$(gh api repos/${{ github.repository }}/milestones --jq '[.[] | select(.state == "open")] | length')
          
          # Store metrics
          echo "total_issues=$TOTAL_ISSUES" >> $GITHUB_OUTPUT
          echo "open_issues=$OPEN_ISSUES" >> $GITHUB_OUTPUT
          echo "closed_this_week=$CLOSED_THIS_WEEK" >> $GITHUB_OUTPUT
          echo "critical_issues=$CRITICAL_ISSUES" >> $GITHUB_OUTPUT
          echo "high_priority=$HIGH_PRIORITY" >> $GITHUB_OUTPUT
          echo "blockers=$BLOCKERS" >> $GITHUB_OUTPUT
          echo "completion_rate=$COMPLETION_RATE" >> $GITHUB_OUTPUT
          echo "risk_score=$RISK_SCORE" >> $GITHUB_OUTPUT
          echo "upcoming_milestones=$UPCOMING_MILESTONES" >> $GITHUB_OUTPUT

      - name: üìà Generate Executive Summary
        if: github.event.inputs.notification_type == 'weekly-digest' || github.event_name == 'schedule'
        run: |
          # Create executive summary for leadership
          mkdir -p notifications/executive
          
          # Determine project health status
          if [ ${{ steps.stakeholder-data.outputs.risk_score }} -ge 20 ]; then
            HEALTH_STATUS="üî¥ ATTENTION REQUIRED"
            HEALTH_COLOR="red"
          elif [ ${{ steps.stakeholder-data.outputs.completion_rate }} -ge 75 ]; then
            HEALTH_STATUS="üü¢ ON TRACK"
            HEALTH_COLOR="green"
          else
            HEALTH_STATUS="üü° MONITOR CLOSELY"
            HEALTH_COLOR="yellow"
          fi
          
          cat > notifications/executive/weekly-digest-$(date +%Y-%m-%d).md << EOF
          # Executive Project Summary
          
          **Week Ending:** $(date +%B\ %d,\ %Y)
          **Project Health:** $HEALTH_STATUS
          **Overall Completion:** ${{ steps.stakeholder-data.outputs.completion_rate }}%
          
          ## üìä Key Metrics
          
          | Metric | Value | Status |
          |--------|-------|--------|
          | Project Completion | ${{ steps.stakeholder-data.outputs.completion_rate }}% | $([ ${{ steps.stakeholder-data.outputs.completion_rate }} -ge 75 ] && echo "üü¢ On Target" || echo "üü° Needs Focus") |
          | Items Completed This Week | ${{ steps.stakeholder-data.outputs.closed_this_week }} | $([ ${{ steps.stakeholder-data.outputs.closed_this_week }} -gt 5 ] && echo "üü¢ Good Velocity" || echo "üü° Low Velocity") |
          | Critical Issues | ${{ steps.stakeholder-data.outputs.critical_issues }} | $([ ${{ steps.stakeholder-data.outputs.critical_issues }} -eq 0 ] && echo "üü¢ None" || echo "üî¥ Requires Action") |
          | Active Blockers | ${{ steps.stakeholder-data.outputs.blockers }} | $([ ${{ steps.stakeholder-data.outputs.blockers }} -eq 0 ] && echo "üü¢ Clear Path" || echo "üõë Blocked") |
          | Risk Score | ${{ steps.stakeholder-data.outputs.risk_score }} | $([ ${{ steps.stakeholder-data.outputs.risk_score }} -lt 15 ] && echo "üü¢ Low Risk" || echo "üî¥ High Risk") |
          
          ## üéØ This Week's Accomplishments
          
          EOF
          
          # Add completed items from this week
          gh issue list --state closed --json number,title,closedAt --jq '[.[] | select(.closedAt | fromdateiso8601 > (now - 604800))] | .[] | "- ‚úÖ #\(.number): \(.title)"' >> notifications/executive/weekly-digest-$(date +%Y-%m-%d).md || echo "- No items completed this week" >> notifications/executive/weekly-digest-$(date +%Y-%m-%d).md
          
          cat >> notifications/executive/weekly-digest-$(date +%Y-%m-%d).md << EOF
          
          ## ‚ö†Ô∏è Items Requiring Executive Attention
          
          EOF
          
          # Add critical and high priority items
          if [ ${{ steps.stakeholder-data.outputs.critical_issues }} -gt 0 ] || [ ${{ steps.stakeholder-data.outputs.high_priority }} -gt 5 ]; then
            gh issue list --label "critical,high-priority" --state open --json number,title,labels --jq '.[] | "- üö® #\(.number): \(.title)"' >> notifications/executive/weekly-digest-$(date +%Y-%m-%d).md
          else
            echo "- ‚úÖ No items requiring immediate executive attention" >> notifications/executive/weekly-digest-$(date +%Y-%m-%d).md
          fi
          
          cat >> notifications/executive/weekly-digest-$(date +%Y-%m-%d).md << EOF
          
          ## üîÆ Next Week Outlook
          
          - **Target Completion Rate:** $(( ${{ steps.stakeholder-data.outputs.completion_rate }} + 5 ))%
          - **Planned Deliverables:** ${{ steps.stakeholder-data.outputs.upcoming_milestones }} milestones approaching
          - **Focus Areas:** $([ ${{ steps.stakeholder-data.outputs.high_priority }} -gt 0 ] && echo "High priority items" || echo "Maintain current momentum")
          
          ## üíº Recommended Executive Actions
          
          $(if [ ${{ steps.stakeholder-data.outputs.risk_score }} -ge 20 ]; then
            echo "- üö® **URGENT:** Schedule risk mitigation meeting"
            echo "- üìû Consider additional resource allocation"
            echo "- üîÑ Review project timeline and scope"
          elif [ ${{ steps.stakeholder-data.outputs.completion_rate }} -lt 50 ]; then
            echo "- üìä Review project progress with team leads"
            echo "- üéØ Consider adjusting priorities or timeline"
            echo "- üí¨ Increase stakeholder communication frequency"
          else
            echo "- ‚úÖ Continue current approach"
            echo "- üëÄ Monitor critical path items"
            echo "- üéâ Recognize team achievements"
          fi)
          
          ---
          
          **Report Generated:** $(date)  
          **Next Report:** $(date -d "+7 days" +%B\ %d,\ %Y)  
          **Contact:** Project Management Office
          EOF

      - name: üë• Generate Team Lead Summary
        if: github.event.inputs.notification_type == 'weekly-digest' || github.event_name == 'schedule'
        run: |
          # Create detailed summary for team leads
          mkdir -p notifications/team-leads
          
          cat > notifications/team-leads/team-summary-$(date +%Y-%m-%d).md << EOF
          # Team Lead Weekly Summary
          
          **Week Ending:** $(date +%B\ %d,\ %Y)
          **Team Performance:** $([ ${{ steps.stakeholder-data.outputs.closed_this_week }} -gt 3 ] && echo "üü¢ Strong" || echo "üü° Needs Improvement")
          
          ## üìà Team Performance Metrics
          
          - **Issues Closed This Week:** ${{ steps.stakeholder-data.outputs.closed_this_week }}
          - **Open Issues:** ${{ steps.stakeholder-data.outputs.open_issues }}
          - **High Priority Items:** ${{ steps.stakeholder-data.outputs.high_priority }}
          - **Blocked Items:** ${{ steps.stakeholder-data.outputs.blockers }}
          
          ## üéØ Focus Areas for Next Week
          
          ### High Priority Items Requiring Attention
          EOF
          
          # Add high priority open issues
          gh issue list --label "high-priority" --state open --json number,title,assignees --jq '.[] | "- üî• #\(.number): \(.title) (Assigned: \(.assignees[].login // "Unassigned"))"' >> notifications/team-leads/team-summary-$(date +%Y-%m-%d).md || echo "- ‚úÖ No high priority items" >> notifications/team-leads/team-summary-$(date +%Y-%m-%d).md
          
          cat >> notifications/team-leads/team-summary-$(date +%Y-%m-%d).md << EOF
          
          ### Blocked Items Needing Resolution
          EOF
          
          # Add blocked issues
          gh issue list --label "blocker" --state open --json number,title,assignees --jq '.[] | "- üõë #\(.number): \(.title) (Assigned: \(.assignees[].login // "Unassigned"))"' >> notifications/team-leads/team-summary-$(date +%Y-%m-%d).md || echo "- ‚úÖ No blocked items" >> notifications/team-leads/team-summary-$(date +%Y-%m-%d).md
          
          cat >> notifications/team-leads/team-summary-$(date +%Y-%m-%d).md << EOF
          
          ## üìÖ Upcoming Deadlines
          EOF
          
          # Add upcoming milestones
          gh api repos/${{ github.repository }}/milestones --jq '[.[] | select(.state == "open")] | sort_by(.due_on) | .[] | "- üìÖ **\(.title):** \(.due_on | split("T")[0]) (\(.open_issues) open issues)"' >> notifications/team-leads/team-summary-$(date +%Y-%m-%d).md || echo "- No upcoming milestones" >> notifications/team-leads/team-summary-$(date +%Y-%m-%d).md
          
          cat >> notifications/team-leads/team-summary-$(date +%Y-%m-%d).md << EOF
          
          ---
          
          **Action Items:**
          - Review high priority assignments
          - Address any blocked items
          - Update progress on assigned issues
          - Escalate any concerns to project management
          EOF

      - name: üö® Generate Critical Alert
        if: github.event.inputs.notification_type == 'critical-alert' || steps.stakeholder-data.outputs.risk_score >= 25
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create critical alert notification
          mkdir -p notifications/alerts
          
          cat > notifications/alerts/critical-alert-$(date +%Y-%m-%d-%H%M).md << EOF
          # üö® CRITICAL PROJECT ALERT
          
          **Alert Time:** $(date)
          **Risk Score:** ${{ steps.stakeholder-data.outputs.risk_score }}
          **Severity:** $([ ${{ steps.stakeholder-data.outputs.risk_score }} -ge 30 ] && echo "SEVERE" || echo "HIGH")
          
          ## üî¥ Critical Issues Requiring Immediate Attention
          
          EOF
          
          # List all critical and blocking issues
          gh issue list --label "critical,blocker" --state open --json number,title,labels,createdAt --jq '.[] | "- üö® **#\(.number):** \(.title) (Created: \(.createdAt | split("T")[0]))"' >> notifications/alerts/critical-alert-$(date +%Y-%m-%d-%H%M).md
          
          cat >> notifications/alerts/critical-alert-$(date +%Y-%m-%d-%H%M).md << EOF
          
          ## ‚ö° Immediate Actions Required
          
          1. **Within 2 Hours:**
             - Acknowledge this alert
             - Assess impact on project timeline
             - Assign owners to critical issues
          
          2. **Within 24 Hours:**
             - Develop mitigation plans
             - Allocate additional resources if needed
             - Update stakeholders on status
          
          3. **Ongoing:**
             - Daily check-ins until resolved
             - Risk register updates
             - Escalation path activation
          
          ## üìû Escalation Contacts
          
          - **Project Manager:** Immediate notification required
          - **Executive Sponsor:** If risk score > 30
          - **Technical Lead:** For technical blockers
          - **PMO:** For process and resource issues
          
          ---
          
          **This is an automated alert. Please respond within 2 hours.**
          EOF
          
          # Create urgent issue for tracking
          gh issue create \
            --title "üö® CRITICAL ALERT: Risk Score ${{ steps.stakeholder-data.outputs.risk_score }} - Immediate Action Required" \
            --label "critical,alert,high-priority" \
            --body "$(cat notifications/alerts/critical-alert-$(date +%Y-%m-%d-%H%M).md)"

      - name: üìÑ Generate Project Summary
        if: github.event.inputs.notification_type == 'project-summary'
        run: |
          # Create comprehensive project summary
          mkdir -p notifications/summary
          
          cat > notifications/summary/project-summary-$(date +%Y-%m-%d).md << EOF
          # Comprehensive Project Summary
          
          **Generated:** $(date)
          **Project Health:** $([ ${{ steps.stakeholder-data.outputs.completion_rate }} -ge 75 ] && echo "üü¢ Healthy" || echo "üü° Needs Attention")
          
          ## üìä Overall Project Status
          
          - **Total Issues:** ${{ steps.stakeholder-data.outputs.total_issues }}
          - **Completion Rate:** ${{ steps.stakeholder-data.outputs.completion_rate }}%
          - **Open Items:** ${{ steps.stakeholder-data.outputs.open_issues }}
          - **Risk Score:** ${{ steps.stakeholder-data.outputs.risk_score }}
          
          ## üéØ Recent Progress (Last 7 Days)
          
          EOF
          
          # Add recent activity
          gh issue list --state closed --json number,title,closedAt --jq '[.[] | select(.closedAt | fromdateiso8601 > (now - 604800))] | .[] | "- ‚úÖ #\(.number): \(.title)"' >> notifications/summary/project-summary-$(date +%Y-%m-%d).md
          
          cat >> notifications/summary/project-summary-$(date +%Y-%m-%d).md << EOF
          
          ## üîÑ Current Active Work
          
          EOF
          
          # Add in-progress items
          gh issue list --label "in-progress" --state open --json number,title --jq '.[] | "- üîÑ #\(.number): \(.title)"' >> notifications/summary/project-summary-$(date +%Y-%m-%d).md || echo "- No items currently in progress" >> notifications/summary/project-summary-$(date +%Y-%m-%d).md

      - name: üíæ Commit Notifications
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Stakeholder Notification System"
          
          # Add all notification files
          git add notifications/ || echo "No notification files to add"
          
          # Commit if there are changes
          if git diff --staged --quiet; then
            echo "No notification changes to commit"
          else
            git commit -m "üìß Generate stakeholder notifications - $(date +%Y-%m-%d)"
            git push
          fi

      - name: üìß Notification Summary
        run: |
          echo "üìß Stakeholder Notification Summary"
          echo "=================================="
          echo "Notification Type: ${{ github.event.inputs.notification_type || 'weekly-digest' }}"
          echo "Project Health: $([ ${{ steps.stakeholder-data.outputs.completion_rate }} -ge 75 ] && echo "üü¢ Healthy" || echo "üü° Monitor")"
          echo "Completion Rate: ${{ steps.stakeholder-data.outputs.completion_rate }}%"
          echo "Risk Score: ${{ steps.stakeholder-data.outputs.risk_score }}"
          echo "Critical Issues: ${{ steps.stakeholder-data.outputs.critical_issues }}"
          echo "Items Closed This Week: ${{ steps.stakeholder-data.outputs.closed_this_week }}"
          echo ""
          if [ ${{ steps.stakeholder-data.outputs.risk_score }} -ge 25 ]; then
            echo "üö® CRITICAL ALERT GENERATED - Immediate attention required!"
          elif [ ${{ steps.stakeholder-data.outputs.completion_rate }} -lt 50 ]; then
            echo "‚ö†Ô∏è Project health requires attention"
          else
            echo "‚úÖ Standard notifications generated successfully"
          fi

