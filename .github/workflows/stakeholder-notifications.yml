name: ðŸ“§ Stakeholder Notification System

on:
  issues:
    types: [opened, closed, labeled]
  milestone:
    types: [created, closed, opened]
  pull_request:
    types: [opened, merged, closed]
  schedule:
    # Weekly roadmap updates every Monday at 7AM Eastern (11AM UTC)
    - cron: '0 11 * * 1'
  workflow_dispatch:
    inputs:
      notification_type:
        description: 'Type of notification to send'
        required: true
        default: 'weekly-digest'
        type: choice
        options:
          - weekly-digest
          - milestone-update
          - critical-alert
          - project-summary

env:
  STAKEHOLDER_GROUPS: "executives,project-managers,team-leads,business-users"

jobs:
  stakeholder-notifications:
    name: Stakeholder Notifications
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: read

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ“Š Collect Stakeholder Data
        id: stakeholder-data
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Collect "in-progress" items and "next" roadmap items
          IN_PROGRESS=$(gh issue list --label "in-progress" --state open --json number,title --jq '.[] | "- #\(.number): \(.title)"')
          NEXT_ROADMAP=$(gh issue list --label "next-on-roadmap" --state open --json number,title --jq '.[] | "- #\(.number): \(.title)"')
          
          # Also collect priority items if no specific roadmap items are labeled
          if [ -z "$NEXT_ROADMAP" ]; then
            NEXT_ROADMAP=$(gh issue list --label "priority-high" --state open --json number,title --jq 'limit(5; .[]) | "- #\(.number): \(.title)"')
          fi
          
          # Fallback messaging if no items found
          if [ -z "$IN_PROGRESS" ]; then
            IN_PROGRESS="- No items currently in progress"
          fi
          
          if [ -z "$NEXT_ROADMAP" ]; then
            NEXT_ROADMAP="- No items currently prioritized for next sprint"
          fi

          # Store data
          echo "in_progress<<EOF" >> $GITHUB_OUTPUT
          echo "$IN_PROGRESS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "next_roadmap<<EOF" >> $GITHUB_OUTPUT
          echo "$NEXT_ROADMAP" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ðŸ“§ Send Weekly Notification
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com  # Gmail SMTP server
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}  # Your Gmail address
          password: ${{ secrets.SMTP_PASSWORD }}   # Your Gmail App Password
          subject: "ðŸ“Š PM Tools Templates - Weekly Project Update"
          from: ${{ secrets.SMTP_USERNAME }}
          to: ${{ secrets.SMTP_USERNAME }}  # Sending to yourself as product owner
          body: |
            ðŸ“Š PM Tools Templates - Weekly Project Update
            
            Week of: $(date +"%B %d, %Y")
            
            ðŸ”„ In-Progress Items:
            ${{ steps.stakeholder-data.outputs.in_progress }}
            
            ðŸŽ¯ Next on Roadmap:
            ${{ steps.stakeholder-data.outputs.next_roadmap }}
            
            ---
            Generated automatically every Monday at 7AM Eastern





      - name: ðŸ“§ Notification Summary
        run: |
          echo "ðŸ“§ Weekly Email Notification Summary"
          echo "===================================="
          echo "Scheduled: Every Monday at 7AM Eastern (11AM UTC)"
          echo "Email will include:"
          echo "- In-Progress Items"
          echo "- Next on Roadmap Items"
          echo ""
          echo "âœ… Workflow configured successfully"

