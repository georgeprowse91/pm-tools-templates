name: ğŸ”Œ API Integration Testing

on:
  schedule:
    # Run API health checks daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      test_scope:
        description: 'API testing scope'
        required: false
        default: 'health-checks-only'
        type: choice
        options:
          - health-checks-only
          - basic-integration
          - mock-testing

jobs:
  api-health-checks:
    name: ğŸ¥ API Health Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ¥ Run Basic Health Checks
        run: |
          echo "ğŸ¥ Running basic API health checks..."
          
          python3 - << 'EOF'
          import requests
          import json
          import time
          from datetime import datetime
          
          def basic_health_check():
              """Perform basic health checks on mock endpoints"""
              
              test_endpoints = [
                  {'name': 'httpbin-get', 'url': 'https://httpbin.org/get'},
                  {'name': 'httpbin-json', 'url': 'https://httpbin.org/json'},
                  {'name': 'httpbin-status', 'url': 'https://httpbin.org/status/200'}
              ]
              
              results = []
              
              for endpoint in test_endpoints:
                  print(f"Testing {endpoint['name']}...")
                  
                  try:
                      start_time = time.time()
                      response = requests.get(endpoint['url'], timeout=30)
                      response_time = (time.time() - start_time) * 1000
                      
                      result = {
                          'name': endpoint['name'],
                          'url': endpoint['url'],
                          'status_code': response.status_code,
                          'response_time_ms': round(response_time, 2),
                          'success': response.status_code < 400,
                          'timestamp': datetime.now().isoformat()
                      }
                      
                      results.append(result)
                      
                      if result['success']:
                          print(f"  âœ… {endpoint['name']}: {result['status_code']} ({result['response_time_ms']}ms)")
                      else:
                          print(f"  âŒ {endpoint['name']}: {result['status_code']} ({result['response_time_ms']}ms)")
                          
                  except Exception as e:
                      result = {
                          'name': endpoint['name'],
                          'url': endpoint['url'],
                          'status_code': 0,
                          'response_time_ms': 0,
                          'success': False,
                          'error': str(e),
                          'timestamp': datetime.now().isoformat()
                      }
                      results.append(result)
                      print(f"  âŒ {endpoint['name']}: Error - {e}")
              
              # Summary
              successful = len([r for r in results if r['success']])
              total = len(results)
              avg_response_time = sum(r['response_time_ms'] for r in results if r['success']) / max(successful, 1)
              
              summary = {
                  'timestamp': datetime.now().isoformat(),
                  'total_tests': total,
                  'successful_tests': successful,
                  'success_rate': round((successful / total) * 100, 1),
                  'avg_response_time_ms': round(avg_response_time, 2),
                  'results': results
              }
              
              # Save results
              import os
              os.makedirs('test-results', exist_ok=True)
              with open('test-results/health-check-results.json', 'w') as f:
                  json.dump(summary, f, indent=2)
              
              print(f"\nğŸ“Š Summary:")
              print(f"  Success Rate: {summary['success_rate']}% ({successful}/{total})")
              print(f"  Average Response Time: {summary['avg_response_time_ms']}ms")
              
              return successful == total
          
          # Run health checks
          success = basic_health_check()
          
          if not success:
              print("::warning::Some health checks failed")
          else:
              print("::notice::All health checks passed")
              print("âœ… API integration testing completed successfully!")
          EOF

      - name: ğŸ“¤ Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-health-check-results-${{ github.run_number }}
          path: test-results/
          retention-days: 7
