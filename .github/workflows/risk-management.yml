name: ğŸš¨ Risk Management Automation

on:
  issues:
    types: [opened, edited, labeled]
  schedule:
    # Run risk assessment every Tuesday and Friday at 10 AM UTC
    - cron: '0 10 * * 2,5'
  workflow_dispatch:
    inputs:
      action:
        description: 'Risk management action'
        required: true
        default: 'assess-risks'
        type: choice
        options:
          - assess-risks
          - escalate-high-risks
          - generate-risk-report
          - update-risk-register

env:
  HIGH_RISK_THRESHOLD: 15 # Risk score threshold for escalation
  CRITICAL_RISK_THRESHOLD: 20 # Risk score threshold for immediate action

jobs:
  risk-management:
    name: Risk Assessment & Management
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ” Identify Risk Issues
        id: risk-analysis
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Find issues with risk-related labels
          RISK_ISSUES=$(gh issue list --label "risk,blocker,critical" --json number,title,labels,body --state open)
          echo "risk_issues=$RISK_ISSUES" >> $GITHUB_OUTPUT
          
          # Count different risk levels
          HIGH_RISKS=$(echo "$RISK_ISSUES" | jq '[.[] | select(.labels[]?.name == "high-risk")] | length')
          CRITICAL_RISKS=$(echo "$RISK_ISSUES" | jq '[.[] | select(.labels[]?.name == "critical")] | length')
          BLOCKERS=$(echo "$RISK_ISSUES" | jq '[.[] | select(.labels[]?.name == "blocker")] | length')
          
          echo "high_risks=$HIGH_RISKS" >> $GITHUB_OUTPUT
          echo "critical_risks=$CRITICAL_RISKS" >> $GITHUB_OUTPUT
          echo "blockers=$BLOCKERS" >> $GITHUB_OUTPUT

      - name: ğŸ“Š Calculate Risk Scores
        id: risk-scoring
        run: |
          # Risk scoring algorithm
          # Critical = 25 points, High = 15 points, Medium = 10 points, Low = 5 points
          # Blocker = +10 points, Bug = +5 points
          
          total_risk_score=0
          
          # Add scores based on issue counts
          critical_score=$(( ${{ steps.risk-analysis.outputs.critical_risks }} * 25 ))
          high_score=$(( ${{ steps.risk-analysis.outputs.high_risks }} * 15 ))
          blocker_score=$(( ${{ steps.risk-analysis.outputs.blockers }} * 10 ))
          
          total_risk_score=$(( critical_score + high_score + blocker_score ))
          
          echo "total_risk_score=$total_risk_score" >> $GITHUB_OUTPUT
          echo "critical_score=$critical_score" >> $GITHUB_OUTPUT
          echo "high_score=$high_score" >> $GITHUB_OUTPUT
          echo "blocker_score=$blocker_score" >> $GITHUB_OUTPUT
          
          # Determine risk level
          if [ $total_risk_score -ge ${{ env.CRITICAL_RISK_THRESHOLD }} ]; then
            echo "risk_level=CRITICAL" >> $GITHUB_OUTPUT
          elif [ $total_risk_score -ge ${{ env.HIGH_RISK_THRESHOLD }} ]; then
            echo "risk_level=HIGH" >> $GITHUB_OUTPUT
          else
            echo "risk_level=MEDIUM" >> $GITHUB_OUTPUT
          fi

      - name: ğŸš¨ Create Risk Escalation Issue
        if: steps.risk-scoring.outputs.risk_level == 'CRITICAL' || (github.event.inputs.action == 'escalate-high-risks' && steps.risk-analysis.outputs.critical_risks > 0)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create escalation issue for critical risks
          gh issue create \
            --title "ğŸš¨ CRITICAL: Risk Escalation Required - Score: ${{ steps.risk-scoring.outputs.total_risk_score }}" \
            --label "critical,risk,escalation,high-priority" \
            --body "## ğŸš¨ Critical Risk Escalation

          **Risk Assessment Date:** $(date)
          **Total Risk Score:** ${{ steps.risk-scoring.outputs.total_risk_score }}
          **Risk Level:** ${{ steps.risk-scoring.outputs.risk_level }}

          ## Risk Breakdown
          - **Critical Risks:** ${{ steps.risk-analysis.outputs.critical_risks }} (Score: ${{ steps.risk-scoring.outputs.critical_score }})
          - **High Risks:** ${{ steps.risk-analysis.outputs.high_risks }} (Score: ${{ steps.risk-scoring.outputs.high_score }})
          - **Blockers:** ${{ steps.risk-analysis.outputs.blockers }} (Score: ${{ steps.risk-scoring.outputs.blocker_score }})

          ## Immediate Actions Required
          - [ ] **Project Manager Review** - Within 2 hours
          - [ ] **Stakeholder Notification** - Within 4 hours  
          - [ ] **Risk Mitigation Plan** - Within 24 hours
          - [ ] **Executive Briefing** - If score > 30

          ## Open Risk Issues
          $(gh issue list --label \"risk,blocker,critical\" --state open --json number,title --jq '.[] | \"- #\\(.number): \\(.title)\"')

          ## Risk Mitigation Strategies
          - [ ] Identify risk owners for each critical item
          - [ ] Develop contingency plans
          - [ ] Allocate additional resources if needed
          - [ ] Update project timeline if necessary
          - [ ] Implement monitoring and early warning systems

          ---
          *Auto-generated by Risk Management Workflow*
          *Threshold: Critical â‰¥ ${{ env.CRITICAL_RISK_THRESHOLD }}, High â‰¥ ${{ env.HIGH_RISK_THRESHOLD }}*"

      - name: ğŸ“‹ Update Risk Register
        if: github.event.inputs.action == 'update-risk-register' || github.event_name == 'schedule'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create risk register directory
          mkdir -p docs/risk-management
          
          # Generate risk register
          cat > docs/risk-management/risk-register.md << EOF
          # Project Risk Register
          
          **Last Updated:** $(date)
          **Total Risk Score:** ${{ steps.risk-scoring.outputs.total_risk_score }}
          **Risk Level:** ${{ steps.risk-scoring.outputs.risk_level }}
          
          ## Risk Summary Dashboard
          
          | Risk Level | Count | Score | Status |
          |------------|-------|-------|--------|
          | Critical   | ${{ steps.risk-analysis.outputs.critical_risks }} | ${{ steps.risk-scoring.outputs.critical_score }} | $([ ${{ steps.risk-analysis.outputs.critical_risks }} -gt 0 ] && echo "ğŸš¨ Action Required" || echo "âœ… Clear") |
          | High       | ${{ steps.risk-analysis.outputs.high_risks }} | ${{ steps.risk-scoring.outputs.high_score }} | $([ ${{ steps.risk-analysis.outputs.high_risks }} -gt 3 ] && echo "âš ï¸  Monitor Closely" || echo "âœ… Manageable") |
          | Blockers   | ${{ steps.risk-analysis.outputs.blockers }} | ${{ steps.risk-scoring.outputs.blocker_score }} | $([ ${{ steps.risk-analysis.outputs.blockers }} -gt 0 ] && echo "ğŸ›‘ Blocking Progress" || echo "âœ… Clear") |
          
          ## Risk Assessment Criteria
          
          ### Risk Scoring System
          - **Critical Risk:** 25 points (Immediate action required)
          - **High Risk:** 15 points (Action required within 48 hours)
          - **Medium Risk:** 10 points (Monitor and plan mitigation)
          - **Low Risk:** 5 points (Document and review periodically)
          - **Blocker:** +10 points (Additional weight for blocking issues)
          
          ### Escalation Thresholds
          - **Critical:** Total score â‰¥ ${{ env.CRITICAL_RISK_THRESHOLD }} (Immediate escalation)
          - **High:** Total score â‰¥ ${{ env.HIGH_RISK_THRESHOLD }} (24-hour escalation)
          
          ## Current Risk Issues
          
          EOF
          
          # Add current risk issues to register
          if [ ${{ steps.risk-analysis.outputs.critical_risks }} -gt 0 ] || [ ${{ steps.risk-analysis.outputs.high_risks }} -gt 0 ] || [ ${{ steps.risk-analysis.outputs.blockers }} -gt 0 ]; then
            echo "### Open Risk Issues" >> docs/risk-management/risk-register.md
            gh issue list --label "risk,blocker,critical" --state open --json number,title,labels,createdAt \
              --jq '.[] | "- **#\(.number):** \(.title) (Created: \(.createdAt | split("T")[0]))"' >> docs/risk-management/risk-register.md
          else
            echo "### âœ… No Current Risk Issues" >> docs/risk-management/risk-register.md
            echo "All identified risks have been resolved or mitigated." >> docs/risk-management/risk-register.md
          fi
          
          # Add risk mitigation guidelines
          cat >> docs/risk-management/risk-register.md << EOF
          
          ## Risk Mitigation Guidelines
          
          ### For Critical Risks (Score â‰¥ ${{ env.CRITICAL_RISK_THRESHOLD }})
          1. **Immediate Response** (Within 2 hours)
             - Notify project manager and key stakeholders
             - Assess impact on project timeline and deliverables
             - Initiate emergency response procedures if needed
          
          2. **Risk Mitigation** (Within 24 hours)
             - Develop specific mitigation strategies
             - Assign risk owners and action items
             - Update project schedule and resource allocation
             - Consider escalation to executive level
          
          ### For High Risks (Score â‰¥ ${{ env.HIGH_RISK_THRESHOLD }})
          1. **Assessment** (Within 24 hours)
             - Evaluate risk impact and probability
             - Identify potential mitigation strategies
             - Assign risk owners
          
          2. **Planning** (Within 48 hours)
             - Develop detailed mitigation plans
             - Update risk register with actions
             - Schedule regular risk review meetings
          
          ### Risk Monitoring
          - **Automated Assessment:** Every Tuesday and Friday
          - **Manual Review:** Weekly team meetings
          - **Escalation:** Automatic for critical risks
          - **Reporting:** Monthly risk summary to stakeholders
          
          ---
          *Auto-updated by Risk Management Workflow*
          *Next automated assessment: $(date -d "next Tuesday" +%Y-%m-%d)*
          EOF

      - name: ğŸ“Š Generate Risk Metrics
        if: github.event.inputs.action == 'generate-risk-report' || github.event_name == 'schedule'
        run: |
          # Create metrics directory
          mkdir -p metrics/risk-data
          
          # Generate risk metrics JSON
          cat > metrics/risk-data/risk-metrics-$(date +%Y-%m-%d).json << EOF
          {
            "assessment_date": "$(date -Iseconds)",
            "total_risk_score": ${{ steps.risk-scoring.outputs.total_risk_score }},
            "risk_level": "${{ steps.risk-scoring.outputs.risk_level }}",
            "risk_breakdown": {
              "critical_risks": ${{ steps.risk-analysis.outputs.critical_risks }},
              "high_risks": ${{ steps.risk-analysis.outputs.high_risks }},
              "blockers": ${{ steps.risk-analysis.outputs.blockers }}
            },
            "score_breakdown": {
              "critical_score": ${{ steps.risk-scoring.outputs.critical_score }},
              "high_score": ${{ steps.risk-scoring.outputs.high_score }},
              "blocker_score": ${{ steps.risk-scoring.outputs.blocker_score }}
            },
            "thresholds": {
              "critical_threshold": ${{ env.CRITICAL_RISK_THRESHOLD }},
              "high_threshold": ${{ env.HIGH_RISK_THRESHOLD }}
            }
          }
          EOF

      - name: ğŸ’¾ Commit Risk Documentation
        if: github.event.inputs.action == 'update-risk-register' || github.event_name == 'schedule'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Risk Management Automation"
          
          # Add all risk-related files
          git add docs/risk-management/ metrics/risk-data/ || echo "No risk files to add"
          
          # Commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ“Š Update risk register and metrics - Score: ${{ steps.risk-scoring.outputs.total_risk_score }} (${{ steps.risk-scoring.outputs.risk_level }})"
            git push
          fi

      - name: ğŸ”” Risk Summary
        if: always()
        run: |
          echo "ğŸš¨ Risk Management Summary"
          echo "========================="
          echo "Assessment Date: $(date)"
          echo "Total Risk Score: ${{ steps.risk-scoring.outputs.total_risk_score }}"
          echo "Risk Level: ${{ steps.risk-scoring.outputs.risk_level }}"
          echo "Critical Risks: ${{ steps.risk-analysis.outputs.critical_risks }}"
          echo "High Risks: ${{ steps.risk-analysis.outputs.high_risks }}"
          echo "Blockers: ${{ steps.risk-analysis.outputs.blockers }}"
          echo ""
          echo "Thresholds:"
          echo "- Critical: â‰¥ ${{ env.CRITICAL_RISK_THRESHOLD }}"
          echo "- High: â‰¥ ${{ env.HIGH_RISK_THRESHOLD }}"
          echo ""
          if [ ${{ steps.risk-scoring.outputs.total_risk_score }} -ge ${{ env.CRITICAL_RISK_THRESHOLD }} ]; then
            echo "ğŸš¨ CRITICAL: Immediate escalation required!"
          elif [ ${{ steps.risk-scoring.outputs.total_risk_score }} -ge ${{ env.HIGH_RISK_THRESHOLD }} ]; then
            echo "âš ï¸  HIGH: Action required within 24 hours"
          else
            echo "âœ… Risk level acceptable"
          fi

