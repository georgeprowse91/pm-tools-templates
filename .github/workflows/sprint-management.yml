name: ðŸš€ Sprint Management Automation

on:
  schedule:
    # Run every Monday at 9 AM UTC (start of sprint week)
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      action:
        description: 'Sprint action to perform'
        required: true
        default: 'start-sprint'
        type: choice
        options:
          - start-sprint
          - end-sprint
          - generate-retrospective
          - update-metrics
      sprint_number:
        description: 'Sprint number (optional)'
        required: false
        type: string

env:
  SPRINT_DURATION: 14 # days
  TEAM_VELOCITY_TARGET: 20 # story points

jobs:
  sprint-automation:
    name: Sprint Management
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      projects: write

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“Š Calculate Sprint Dates
        id: dates
        run: |
          current_date=$(date +%Y-%m-%d)
          sprint_start=$(date +%Y-%m-%d)
          # Use GNU date syntax that works on Ubuntu runners
          sprint_end=$(date -d "$current_date + 14 days" +%Y-%m-%d)
          
          echo "current_date=$current_date" >> $GITHUB_OUTPUT
          echo "sprint_start=$sprint_start" >> $GITHUB_OUTPUT
          echo "sprint_end=$sprint_end" >> $GITHUB_OUTPUT
          
          # Calculate sprint number based on weeks since project start
          project_start="2025-06-17"
          days_diff=$(( ($(date -d "$current_date" +%s) - $(date -d "$project_start" +%s)) / 86400 ))
          sprint_number=$(( days_diff / 14 + 1 ))
          echo "sprint_number=$sprint_number" >> $GITHUB_OUTPUT

      - name: ðŸŽ¯ Start New Sprint
        if: github.event.inputs.action == 'start-sprint' || github.event_name == 'schedule'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SPRINT_INPUT: ${{ github.event.inputs.sprint_number }}
          SPRINT_CALCULATED: ${{ steps.dates.outputs.sprint_number }}
          SPRINT_START: ${{ steps.dates.outputs.sprint_start }}
          SPRINT_END: ${{ steps.dates.outputs.sprint_end }}
          TEAM_VELOCITY: ${{ env.TEAM_VELOCITY_TARGET }}
          GITHUB_REPO: ${{ github.repository }}
        run: |
          if [ -n "$SPRINT_INPUT" ]; then
            SPRINT_NUM="$SPRINT_INPUT"
          else
            SPRINT_NUM="$SPRINT_CALCULATED"
          fi
          
          # Create issue body in a temporary file
          cat > /tmp/sprint_body.md << EOF
          ## Sprint $SPRINT_NUM Planning
          
          **Sprint Duration:** ${{ steps.dates.outputs.sprint_start }} to ${{ steps.dates.outputs.sprint_end }}
          **Target Velocity:** ${{ env.TEAM_VELOCITY_TARGET }} story points
          
          ## Sprint Goals
          - [ ] Define sprint objectives
          - [ ] Review and prioritize backlog
          - [ ] Estimate story points
          - [ ] Assign tasks to team members
          - [ ] Set up sprint board
          
          ## Sprint Ceremonies
          - **Sprint Planning:** ${{ steps.dates.outputs.sprint_start }} 9:00 AM
          - **Daily Standups:** Every day 9:30 AM
          - **Sprint Review:** ${{ steps.dates.outputs.sprint_end }} 2:00 PM
          - **Sprint Retrospective:** ${{ steps.dates.outputs.sprint_end }} 3:00 PM
          
          ## Success Criteria
          - [ ] All story points estimated
          - [ ] Sprint backlog finalized
          - [ ] Team capacity confirmed
          - [ ] Risks identified and mitigated
          
          ---
          *Auto-generated by Sprint Management Workflow*
          EOF
          
          # Create Sprint Planning Issue
          gh issue create \
            --title "ðŸš€ Sprint $SPRINT_NUM Planning" \
            --label "sprint,planning,agile" \
            --milestone "Sprint $SPRINT_NUM" \
            --body-file /tmp/sprint_body.md

          # Create Sprint milestone if it doesn't exist
          gh api repos/${{ github.repository }}/milestones \
            --method POST \
            --field title="Sprint $SPRINT_NUM" \
            --field description="Sprint $SPRINT_NUM: ${{ steps.dates.outputs.sprint_start }} - ${{ steps.dates.outputs.sprint_end }}" \
            --field due_on="${{ steps.dates.outputs.sprint_end }}T23:59:59Z" || echo "Milestone may already exist"

      - name: ðŸ“ Generate Sprint Report
        if: github.event.inputs.action == 'end-sprint'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -n "${{ github.event.inputs.sprint_number }}" ]; then
            SPRINT_NUM="${{ github.event.inputs.sprint_number }}"
          else
            SPRINT_NUM="${{ steps.dates.outputs.sprint_number }}"
          fi
          
          # Get sprint statistics
          COMPLETED_ISSUES=$(gh issue list --milestone "Sprint $SPRINT_NUM" --state closed --json number | jq length)
          TOTAL_ISSUES=$(gh issue list --milestone "Sprint $SPRINT_NUM" --json number | jq length)
          
          # Create sprint report directory
          mkdir -p reports/sprints
          
          # Generate sprint report
          cat > reports/sprints/sprint-${SPRINT_NUM}-report.md << EOF
          # Sprint $SPRINT_NUM Report
          
          **Sprint Period:** ${{ steps.dates.outputs.sprint_start }} to ${{ steps.dates.outputs.sprint_end }}
          **Generated:** $(date)
          
          ## Sprint Summary
          - **Total Issues:** $TOTAL_ISSUES
          - **Completed Issues:** $COMPLETED_ISSUES
          - **Completion Rate:** $(( COMPLETED_ISSUES * 100 / TOTAL_ISSUES ))%
          - **Target Velocity:** ${{ env.TEAM_VELOCITY_TARGET }} story points
          
          ## Completed Issues
          EOF
          
          # Add completed issues to report
          gh issue list --milestone "Sprint $SPRINT_NUM" --state closed --json number,title,labels \
            --jq '.[] | "- #" + (.number | tostring) + ": " + .title' >> reports/sprints/sprint-${SPRINT_NUM}-report.md
          
          # Commit the report
          git config --local user.email "action@github.com"
          git config --local user.name "Sprint Automation"
          git add reports/sprints/sprint-${SPRINT_NUM}-report.md
          git commit -m "ðŸ“Š Add Sprint $SPRINT_NUM report" || echo "No changes to commit"
          git push

      - name: ðŸ”„ Generate Retrospective Template
        if: github.event.inputs.action == 'generate-retrospective'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -n "${{ github.event.inputs.sprint_number }}" ]; then
            SPRINT_NUM="${{ github.event.inputs.sprint_number }}"
          else
            SPRINT_NUM="${{ steps.dates.outputs.sprint_number }}"
          fi
          
          # Create retrospective body in a temporary file
          cat > /tmp/retrospective_body.md << EOF
          ## Sprint $SPRINT_NUM Retrospective
          
          **Sprint Period:** ${{ steps.dates.outputs.sprint_start }} to ${{ steps.dates.outputs.sprint_end }}
          **Meeting Date:** ${{ steps.dates.outputs.sprint_end }}
          
          ## What Went Well? ðŸŸ¢
          - [ ] Item 1
          - [ ] Item 2
          - [ ] Item 3
          
          ## What Didn't Go Well? ðŸ”´
          - [ ] Item 1
          - [ ] Item 2
          - [ ] Item 3
          
          ## What Can We Improve? ðŸ”„
          - [ ] Action item 1 (Owner: TBD, Due: TBD)
          - [ ] Action item 2 (Owner: TBD, Due: TBD)
          - [ ] Action item 3 (Owner: TBD, Due: TBD)
          
          ## Sprint Metrics
          - **Velocity:** _TBD_ story points
          - **Completion Rate:** _TBD_%
          - **Blockers Encountered:** _TBD_
          - **Team Satisfaction:** _TBD/5_
          
          ## Action Items for Next Sprint
          - [ ] Action 1
          - [ ] Action 2
          - [ ] Action 3
          
          ---
          *Auto-generated by Sprint Management Workflow*
          EOF
          
          # Create retrospective issue
          gh issue create \
            --title "ðŸ”„ Sprint $SPRINT_NUM Retrospective" \
            --label "retrospective,sprint,agile" \
            --milestone "Sprint $SPRINT_NUM" \
            --body-file /tmp/retrospective_body.md

      - name: ðŸ“ˆ Update Sprint Metrics
        if: github.event.inputs.action == 'update-metrics' || github.event_name == 'schedule'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -n "${{ github.event.inputs.sprint_number }}" ]; then
            SPRINT_NUM="${{ github.event.inputs.sprint_number }}"
          else
            SPRINT_NUM="${{ steps.dates.outputs.sprint_number }}"
          fi
          
          # Create metrics directory
          mkdir -p metrics/sprint-data
          
          # Generate metrics JSON
          cat > metrics/sprint-data/sprint-${SPRINT_NUM}-metrics.json << EOF
          {
            "sprint_number": $SPRINT_NUM,
            "sprint_start": "${{ steps.dates.outputs.sprint_start }}",
            "sprint_end": "${{ steps.dates.outputs.sprint_end }}",
            "generated_at": "$(date -Iseconds)",
            "metrics": {
              "total_issues": $(gh issue list --milestone "Sprint $SPRINT_NUM" --json number | jq length),
              "completed_issues": $(gh issue list --milestone "Sprint $SPRINT_NUM" --state closed --json number | jq length),
              "open_issues": $(gh issue list --milestone "Sprint $SPRINT_NUM" --state open --json number | jq length),
              "target_velocity": ${{ env.TEAM_VELOCITY_TARGET }}
            }
          }
          EOF
          
          # Commit metrics
          git config --local user.email "action@github.com"
          git config --local user.name "Sprint Automation"
          git add metrics/sprint-data/sprint-${SPRINT_NUM}-metrics.json
          git commit -m "ðŸ“Š Update Sprint $SPRINT_NUM metrics" || echo "No changes to commit"
          git push

      - name: ðŸ“§ Send Sprint Notifications
        if: always()
        run: |
          if [ -n "${{ github.event.inputs.sprint_number }}" ]; then
            SPRINT_NUM="${{ github.event.inputs.sprint_number }}"
          else
            SPRINT_NUM="${{ steps.dates.outputs.sprint_number }}"
          fi
          
          ACTION="${{ github.event.inputs.action }}"
          if [ -z "$ACTION" ]; then
            ACTION="scheduled"
          fi
          
          echo "ðŸš€ Sprint management workflow completed"
          echo "Action: $ACTION"
          echo "Sprint: $SPRINT_NUM"
          echo "Date: ${{ steps.dates.outputs.current_date }}"
          echo "Status: Success"

