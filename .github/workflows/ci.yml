name: CI
on:
  push:
    branches: [ main, staging, develop ]
  pull_request:
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      docs: ${{ steps.filter.outputs.docs }}
      site: ${{ steps.filter.outputs.site }}
      node: ${{ steps.filter.outputs.node }}
      python: ${{ steps.filter.outputs.python }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 1 }
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            docs:
              - 'docs/**'
              - '**/*.md'
            site:
              - 'website/**'
              - 'docs/site/**'
              - 'site/**'
              - '.github/workflows/build-deploy-site.yml'
            node:
              - '**/package.json'
              - '**/package-lock.json'
              - '**/*.js'
              - '**/*.ts'
            python:
              - '**/requirements*.txt'
              - '**/*.py'

  detect-packages:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 1 }
      - name: Detect packages with package.json
        id: set-matrix
        run: |
          # Find directories with package.json files (excluding node_modules)
          packages=$(find . -name 'package.json' -not -path '*/node_modules/*' -type f | sed 's|/package.json||' | sed 's|^./||' | jq -R -s -c 'split("\n") | map(select(. != "")) | map({"package": .})')
          echo "matrix={\"include\":$packages}" >> $GITHUB_OUTPUT
          echo "Found packages: $packages"

  build-test:
    runs-on: ubuntu-latest
    steps:
      - name: CI timestamps
        run: |
          echo "run_started_at=${{ github.run_started_at }}"
          date -u +"now_utc=%Y-%m-%dT%H:%M:%SZ"
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            **/package-lock.json
      - name: Install dependencies (timed)
        run: ./scripts/measure_step.sh "npm install" -- bash -lc "if [ -f package-lock.json ]; then npm ci; else npm install; fi"
      - name: Test (coverage, fail if below thresholds)
        run: ./scripts/measure_step.sh "unit tests (coverage)" -- npm run test:ci
      - uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage
      - name: Upload timings
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gha-timings-ci
          path: gha-timings/timings.jsonl
          retention-days: 7

  test-matrix:
    needs: detect-packages
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix: ${{ fromJson(needs.detect-packages.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 1 }
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            **/package-lock.json
      - name: Install root deps
        run: npm ci || npm install
      - name: CI timestamps
        run: |
          echo "run_started_at=${{ github.run_started_at }}"
          date -u +"now_utc=%Y-%m-%dT%H:%M:%SZ"
      - name: Test ${{ matrix.package }} (coverage)
        run: |
          ./scripts/measure_step.sh "test ${{ matrix.package }}" -- \
            npm --prefix "${{ matrix.package }}" run test:ci --if-present
      - name: Upload coverage for ${{ matrix.package }}
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.package }}
          path: |
            ${{ matrix.package }}/coverage
          if-no-files-found: ignore
          retention-days: 7
      - name: Upload timings
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gha-timings-${{ matrix.package }}
          path: gha-timings/timings.jsonl
          if-no-files-found: ignore
          retention-days: 7

  merge-coverage:
    needs: [build-test, test-matrix]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 1 }
      - uses: actions/setup-node@v4
        with: { node-version: '20' }
      - name: Download all coverage artifacts
        uses: actions/download-artifact@v4
        with: { path: cov-artifacts }
      - name: Merge coverage (nyc) and gate
        run: |
          npm i -D nyc
          mkdir -p coverage
          mapfile -t files < <(find cov-artifacts -type f -name 'coverage-final.json')
          if (( ${#files[@]} == 0 )); then
            echo "No coverage-final.json files found"; exit 0
          fi
          npx nyc merge "${files[@]}" coverage/coverage-final.json
          npx nyc report --reporter=json-summary --reporter=html --report-dir coverage
          node - <<'JS'
          const fs=require('fs');
          const sum=JSON.parse(fs.readFileSync('coverage/coverage-summary.json','utf8')).total;
          const thr={branches:80, functions:85, lines:85, statements:85};
          const ok= sum.branches.pct>=thr.branches && sum.functions.pct>=thr.functions && sum.lines.pct>=thr.lines && sum.statements.pct>=thr.statements;
          if(!ok){ console.error('Coverage gate failed:', {actual: sum, thr}); process.exit(1); }
          console.log('Coverage gate passed:', {actual: sum, thr});
JS
      - name: Upload merged coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-merged
          path: coverage
          retention-days: 7

  validate-index-and-links:
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.docs == 'true' || needs.changes.outputs.node == 'true' }}
    steps:
      - name: CI timestamps
        run: |
          echo "run_started_at=${{ github.run_started_at }}"
          date -u +"now_utc=%Y-%m-%dT%H:%M:%SZ"
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            **/package-lock.json
      - name: Install deps (timed)
        run: ./scripts/measure_step.sh "npm install (validate)" -- bash -lc "if [ -f package-lock.json ]; then npm ci; else npm install; fi"
      - name: Validate canonical paths
        run: node scripts/validate-canonical-paths.js --strict
      - name: Generate index (check for drift)
        run: |
          node scripts/generate-template-index.js
          # Fail CI if the generated index has uncommitted changes
          if git ls-files --error-unmatch TEMPLATE_INDEX.md >/dev/null 2>&1; then
            if [[ -n "$(git status --porcelain TEMPLATE_INDEX.md)" ]]; then
              echo "Template index drift detected. Please run the generator and commit changes." >&2
              git --no-pager diff -- TEMPLATE_INDEX.md || true
              exit 1
            fi
          else
            echo "TEMPLATE_INDEX.md not tracked; skipping drift check"
          fi
      - name: Anchor link check (filtered)
        run: python3 check_anchor_links_filtered.py
      - name: Upload validation timings
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gha-timings-validate
          path: gha-timings/timings.jsonl
          retention-days: 7

  preview-a11y-perf:
    if: ${{ github.actor != 'dependabot[bot]' }}
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.site == 'true' }}
    continue-on-error: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    steps:
      - name: CI timestamps
        run: |
          echo "run_started_at=${{ github.run_started_at }}"
          date -u +"now_utc=%Y-%m-%dT%H:%M:%SZ"
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'site/package-lock.json'
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('site/package-lock.json') }}
          restore-keys: |
            playwright-${{ runner.os }}-
      - name: Install dependencies (timed)
        working-directory: site
        run: ../scripts/measure_step.sh "web install" -- bash -lc "if [ -f package-lock.json ]; then npm ci; else npm i; fi"
      - name: Install Playwright browsers (timed)
        working-directory: site
        run: ../scripts/measure_step.sh "pw install" -- bash -lc "npx playwright install --with-deps chromium"
      - name: Start server
        working-directory: site
        run: |
          node server.js &
          echo $! > .server.pid
      - name: Wait for server
        working-directory: site
        run: npx wait-on http://localhost:5173
      - name: Run E2E + a11y tests (timed)
        working-directory: site
        run: ../scripts/measure_step.sh "e2e" -- bash -lc "npx playwright test"
      - name: Lighthouse CI (timed)
        working-directory: site
        run: ../scripts/measure_step.sh "lhci" -- bash -lc "npx lhci autorun --collect.url=http://localhost:5173"
      - name: Stop server
        working-directory: site
        if: always()
        run: kill $(cat .server.pid)
      - name: Upload preview timings
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gha-timings-preview
          path: gha-timings/timings.jsonl
          retention-days: 7
