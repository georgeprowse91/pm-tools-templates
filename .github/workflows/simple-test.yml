name: Simple Email Test

on:
  workflow_dispatch:

concurrency:
  group: simple-test-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  test:
    # Only run on manual dispatch; skip push/PR to avoid affecting checks
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    
    steps:
    - name: Debug context
      run: |
        echo "event=${{ github.event_name }}"
        echo "ref=${{ github.ref }}"
        echo "sha=${{ github.sha }}"
        echo "actor=${{ github.actor }}"
        echo "workflow_ref=${{ github.workflow_ref }}"
        echo "workflow_sha=${{ github.workflow_sha }}"
        echo "run_attempt=${{ github.run_attempt }}"
        echo "run_id=${{ github.run_id }}"
    - name: CI timestamps
      run: |
        echo "run_started_at=${{ github.run_started_at }}"
        date -u +"now_utc=%Y-%m-%dT%H:%M:%SZ"

    - uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: Prepare timings (noop)
      run: ./scripts/measure_step.sh "noop" -- bash -lc "echo 'collect timings context'"

    - name: Send Test Email
      if: ${{ secrets.EMAIL_USERNAME != '' && secrets.EMAIL_PASSWORD != '' && secrets.EMAIL_RECIPIENTS != '' && secrets.EMAIL_FROM != '' }}
      continue-on-error: true
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "Test Email from GitHub Actions"
        body: "This is a test email from GitHub Actions workflow."
        to: ${{ secrets.EMAIL_RECIPIENTS }}
        from: ${{ secrets.EMAIL_FROM }}
        
    - name: Report Status
      run: |
        if [ "${{ secrets.EMAIL_USERNAME }}" != "" ]; then
          echo "✅ Test email sent successfully!"
        else
          echo "❌ EMAIL_USERNAME secret not configured"
        fi

    - name: Ensure timings file exists
      if: always()
      run: |
        mkdir -p gha-timings
        : > gha-timings/timings.jsonl

    - name: Upload timings
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: gha-timings-simple-test
        path: gha-timings/timings.jsonl
        retention-days: 7
